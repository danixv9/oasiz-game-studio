<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Saw Dodge</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --console-color: #6a4a8f;
            --console-color-dark: #5a3a7a;
            --console-color-light: #7a5a9f;
            --console-btn-color: #f0e6f5;
            --console-btn-dark: #d4c6df;
            --screen-border: #2a2a2a;
            --screen-bg: #f0e6f5;
            --danger-red: #c84040;
            --pixel-black: #1a1a1a;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #1a1a2e;
            font-family: 'Press Start 2P', monospace;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background 0.5s ease;
        }

        @media (pointer: coarse) {
            html, body {
                background: var(--console-color);
            }
        }

        /* Checkered background pattern on the console - inside container */

        #game-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(45deg, var(--console-color-dark) 25%, transparent 25%),
                linear-gradient(-45deg, var(--console-color-dark) 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, var(--console-color-dark) 75%),
                linear-gradient(-45deg, transparent 75%, var(--console-color-dark) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            pointer-events: none;
            z-index: 0;
            border-radius: 24px;
            transition: background-image 0.5s ease;
        }

        @media (pointer: coarse) {
            #game-container::before {
                border-radius: 0;
            }
        }

        /* Desktop background pattern */

        @media (pointer: fine) {
            body::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: 
                    radial-gradient(circle at 50% 50%, #2a2a4e 0%, #1a1a2e 70%);
                pointer-events: none;
                z-index: -1;
            }
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 420px;
            max-height: 850px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            z-index: 1;
            margin: auto;
            border-radius: 24px;
            background: var(--console-color);
            box-shadow: 
                0 0 0 4px var(--console-color-dark),
                0 0 0 8px rgba(0,0,0,0.2),
                0 8px 30px rgba(0,0,0,0.4);
            transition: background 0.5s ease, box-shadow 0.5s ease;
        }

        @media (pointer: coarse) {
            #game-container {
                max-width: none;
                max-height: none;
                border-radius: 0;
                box-shadow: none;
            }
        }

        /* Game screen area - enhanced with more depth */

        #screen-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            flex: 1;
            max-height: 55%;
            background: #0a0a0a;
            border: 8px solid var(--screen-border);
            border-radius: 12px;
            box-shadow: 
                inset 0 0 0 3px #1a1a1a,
                inset 0 0 20px rgba(0,0,0,0.8),
                0 6px 0 0 #3a3a3a,
                0 10px 0 0 #2a2a2a,
                0 14px 20px rgba(0,0,0,0.3);
            overflow: hidden;
            margin-top: 20px;
            z-index: 2;
            transition: border-color 0.5s ease;
        }

        @media (pointer: coarse) {
            #screen-container {
                margin-top: 100px;
                max-height: 50%;
                max-width: 400px;
            }
        }

        /* Screen bezel shine effect */

        #screen-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30%;
            background: linear-gradient(180deg, rgba(255,255,255,0.03) 0%, transparent 100%);
            pointer-events: none;
            z-index: 10;
        }

        #gameCanvas {
            display: block;
            width: 100%;
            height: 100%;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }

        /* HUD below screen */

        #hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 360px;
            padding: 12px 10px;
            margin-top: 4px;
            z-index: 2;
        }

        .hud-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #000000;
            padding: 12px 18px;
            border-radius: 12px;
            border: 4px solid #ffffff;
            box-shadow: 
                0 6px 0 rgba(0,0,0,0.4),
                inset 0 0 10px rgba(255,255,255,0.1);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275), border-color 0.2s;
            min-width: 110px;
        }

        .hud-label {
            font-size: 10px;
            color: #ffffff;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: bold;
            opacity: 0.9;
        }

        .hud-value {
            font-size: 24px;
            color: #ffffff;
            text-shadow: 
                0 0 8px rgba(255,255,255,0.3);
            letter-spacing: 3px;
        }

        .hud-item.pop {
            transform: scale(1.1);
            border-color: #ffff00;
            box-shadow: 
                0 0 10px rgba(255,255,0,0.3),
                0 6px 0 rgba(0,0,0,0.4);
        }

        @media (pointer: coarse) {
            #hud {
                max-width: 400px;
            }
            .hud-item {
                min-width: 130px;
                padding: 14px 22px;
            }
            .hud-value {
                font-size: 28px;
            }
            .hud-label {
                font-size: 11px;
            }
        }

        /* Progress bar - high performance look */

        #progress-container {
            width: 100%;
            max-width: 360px;
            height: 24px;
            background: #111111;
            border: 4px solid var(--pixel-black);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 
                0 4px 0 rgba(0,0,0,0.3),
                inset 0 2px 10px rgba(0,0,0,0.9);
            z-index: 2;
            margin-top: 12px;
            position: relative;
        }

        @media (pointer: coarse) {
            #progress-container {
                max-width: 400px;
                height: 28px;
            }
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, 
                #00ff00 0%, 
                #ffff00 50%, 
                #ff0000 100%);
            transition: width 0.3s ease;
            box-shadow: 
                inset 0 6px 6px rgba(255,255,255,0.5),
                inset 0 -6px 6px rgba(0,0,0,0.3);
            position: relative;
        }

        /* Progress bar sheen */

        #progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: rgba(255,255,255,0.2);
            pointer-events: none;
        }

        /* Control buttons area */

        #controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 380px;
            padding: 12px 8px;
            margin-top: 6px;
            z-index: 2;
        }

        @media (pointer: coarse) {
            #controls {
                max-width: 420px;
                padding: 16px 8px;
                margin-top: -10px;
            }
        }

        /* D-Pad style buttons - enhanced with more depth */

        #dpad {
            display: flex;
            gap: 10px;
        }

        .arrow-btn {
            width: 58px;
            height: 58px;
            background: linear-gradient(180deg, #ffffff 0%, var(--console-btn-color) 40%, var(--console-btn-dark) 100%);
            border: 5px solid var(--pixel-black);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 5px 0 0 #404040,
                0 7px 0 0 #2a2a2a,
                0 10px 8px rgba(0,0,0,0.2),
                inset 0 2px 0 rgba(255,255,255,0.8),
                inset 0 -4px 0 rgba(0,0,0,0.1);
            transition: transform 0.05s, box-shadow 0.05s, background 0.5s ease;
            touch-action: manipulation;
        }

        .arrow-btn:active, .arrow-btn.pressed {
            transform: translateY(5px);
            box-shadow: 
                0 0 0 0 #404040,
                0 2px 0 0 #2a2a2a,
                0 4px 4px rgba(0,0,0,0.1),
                inset 0 3px 6px rgba(0,0,0,0.2);
        }

        .arrow-btn svg {
            width: 26px;
            height: 26px;
            fill: var(--pixel-black);
            filter: drop-shadow(1px 1px 0 rgba(255,255,255,0.5));
        }

        @media (pointer: coarse) {
            .arrow-btn {
                width: 68px;
                height: 68px;
            }
            .arrow-btn svg {
                width: 30px;
                height: 30px;
            }
        }

        /* Jump button - larger and more prominent */

        #jump-btn {
            width: 74px;
            height: 74px;
            background: linear-gradient(180deg, #ffffff 0%, var(--console-btn-color) 40%, var(--console-btn-dark) 100%);
            border: 5px solid var(--pixel-black);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 6px 0 0 #404040,
                0 8px 0 0 #2a2a2a,
                0 12px 10px rgba(0,0,0,0.25),
                inset 0 3px 0 rgba(255,255,255,0.8),
                inset 0 -5px 0 rgba(0,0,0,0.1);
            transition: transform 0.05s, box-shadow 0.05s, background 0.5s ease;
            touch-action: manipulation;
        }

        #jump-btn:active, #jump-btn.pressed {
            transform: translateY(6px);
            box-shadow: 
                0 0 0 0 #404040,
                0 2px 0 0 #2a2a2a,
                0 4px 4px rgba(0,0,0,0.1),
                inset 0 4px 8px rgba(0,0,0,0.25);
        }

        #jump-btn::after {
            content: '';
            width: 40px;
            height: 40px;
            background: linear-gradient(180deg, var(--console-color-light) 0%, var(--console-color) 50%, var(--console-color-dark) 100%);
            border: 4px solid var(--pixel-black);
            border-radius: 50%;
            box-shadow: 
                inset 0 2px 0 rgba(255,255,255,0.3),
                inset 0 -2px 0 rgba(0,0,0,0.2);
            transition: background 0.5s ease;
        }

        @media (pointer: coarse) {
            #jump-btn {
                width: 88px;
                height: 88px;
                border-width: 6px;
            }
            #jump-btn::after {
                width: 48px;
                height: 48px;
            }
        }

        /* Pause button - refined */

        #pauseBtn {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 38px;
            height: 38px;
            background: linear-gradient(180deg, #ffffff 0%, var(--screen-bg) 100%);
            border: 4px solid var(--pixel-black);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 
                0 4px 0 0 #404040,
                0 6px 0 0 #2a2a2a;
            z-index: 20;
            transition: transform 0.05s, box-shadow 0.05s;
        }

        #pauseBtn:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 0 #404040, 0 2px 0 0 #2a2a2a;
        }

        #pauseBtn svg {
            width: 16px;
            height: 16px;
            fill: var(--pixel-black);
        }

        @media (pointer: coarse) {
            #pauseBtn {
                top: 115px;
                width: 42px;
                height: 42px;
            }
            #pauseBtn svg {
                width: 18px;
                height: 18px;
            }
        }

        /* Overlays - enhanced with animation */

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .overlay:not(.hidden) {
            pointer-events: auto;
        }

        .overlay-content {
            text-align: center;
            padding: 35px 30px;
            background: linear-gradient(180deg, #ffffff 0%, var(--console-btn-color) 100%);
            border: 8px solid var(--pixel-black);
            border-radius: 16px;
            box-shadow: 
                0 10px 0 0 #404040,
                0 15px 0 0 #2a2a2a,
                0 20px 30px rgba(0,0,0,0.4);
            max-width: 92%;
            width: 340px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: background 0.5s ease;
            position: relative;
            z-index: 10;
        }

        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Start Screen - Solid white background, no Game Boy visible */

        #startScreen {
            background: #ffffff !important;
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            overflow: hidden;
            border-radius: 8px;
        }

        #startScreen.hidden {
            display: none !important;
        }

        /* Falling saws container */

        .falling-saws {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
            z-index: 0;
        }

        .falling-saw {
            position: absolute;
            top: -100px;
            animation: sawFall linear infinite;
        }

        @keyframes sawFall {
            0% {
                transform: translateY(0) rotate(0deg);
            }
            100% {
                transform: translateY(var(--fall-distance, 800px)) rotate(720deg);
            }
        }

        @keyframes sawSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Start Screen Specifics */

        .title-container {
            position: relative;
            margin-bottom: 30px;
        }

        .game-title {
            font-size: 1.8rem;
            color: var(--pixel-black);
            margin-bottom: 4px;
            line-height: 1.2;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
            letter-spacing: -1px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(-1deg); }
            50% { transform: translateY(-10px) rotate(1deg); }
        }

        .game-subtitle {
            font-size: 0.7rem;
            color: var(--danger-red);
            font-weight: bold;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .title-saw {
            position: absolute;
            width: 40px;
            height: 40px;
            opacity: 0.15;
            z-index: -1;
            animation: sawSpin 4s linear infinite;
        }

        .saw-l { top: -20px; left: -30px; }

        .saw-r { bottom: -10px; right: -30px; }

        .instruction-box {
            background: rgba(0,0,0,0.05);
            padding: 15px;
            border-radius: 8px;
            border: 2px dashed rgba(0,0,0,0.2);
            margin-bottom: 25px;
        }

        .instructions {
            font-size: 0.5rem;
            color: var(--pixel-black);
            line-height: 1.8;
            margin-bottom: 0;
            opacity: 0.8;
            text-align: left;
        }

        .instruction-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .instruction-item:last-child { margin-bottom: 0; }

        .instruction-dot {
            width: 8px;
            height: 8px;
            background: var(--console-color);
            border-radius: 2px;
        }

        #startButton {
            width: 100%;
            padding: 18px;
            font-size: 0.9rem;
            letter-spacing: 2px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); box-shadow: 0 0 15px rgba(90, 143, 74, 0.4); }
            100% { transform: scale(1); }
        }

        .btn {
            background: linear-gradient(180deg, var(--console-color-light) 0%, var(--console-color) 50%, var(--console-color-dark) 100%);
            color: #ffffff;
            border: 5px solid var(--pixel-black);
            padding: 14px 24px;
            font-family: 'Press Start 2P', monospace;
            font-size: 0.65rem;
            cursor: pointer;
            border-radius: 6px;
            box-shadow: 
                0 5px 0 0 #3a5a2a,
                0 7px 0 0 #2a4a1a,
                inset 0 2px 0 rgba(255,255,255,0.2);
            transition: transform 0.05s, box-shadow 0.05s, background 0.5s ease;
            margin: 5px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn:active {
            transform: translateY(5px);
            box-shadow: 
                0 0 0 0 #3a5a2a,
                0 2px 0 0 #2a4a1a,
                inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: linear-gradient(180deg, #f0e8e0 0%, var(--console-btn-dark) 50%, #c8c0b8 100%);
            color: var(--pixel-black);
            box-shadow: 
                0 5px 0 0 #a8a098,
                0 7px 0 0 #888078,
                inset 0 2px 0 rgba(255,255,255,0.4);
            text-shadow: none;
            transition: background 0.5s ease;
        }

        .btn-secondary:active {
            box-shadow: 
                0 0 0 0 #a8a098,
                0 2px 0 0 #888078,
                inset 0 2px 4px rgba(0,0,0,0.15);
        }

        /* Score display - enhanced */

        .final-score {
            font-size: 2.2rem;
            color: var(--pixel-black);
            margin: 12px 0;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.1);
        }

        .score-label {
            font-size: 0.45rem;
            color: var(--pixel-black);
            opacity: 0.5;
            margin-bottom: 4px;
        }

        .coins-collected {
            font-size: 0.55rem;
            color: #b8860b;
            margin-bottom: 16px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }

        /* Settings Modal - refined */

        .settings-modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #ffffff 0%, var(--console-btn-color) 100%);
            border: 8px solid var(--pixel-black);
            border-radius: 12px;
            padding: 22px 20px;
            z-index: 150;
            box-shadow: 
                0 8px 0 0 #404040,
                0 12px 0 0 #2a2a2a,
                0 16px 30px rgba(0,0,0,0.4);
            min-width: 240px;
            transition: background 0.5s ease;
        }

        .settings-modal.hidden {
            display: none;
        }

        .settings-title {
            font-size: 0.7rem;
            color: var(--pixel-black);
            margin-bottom: 18px;
            text-align: center;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 3px solid rgba(0,0,0,0.1);
        }

        .settings-row:last-of-type {
            border-bottom: none;
        }

        .settings-label {
            font-size: 0.45rem;
            color: var(--pixel-black);
        }

        .toggle {
            width: 48px;
            height: 26px;
            background: #b0a8a0;
            border: 4px solid var(--pixel-black);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            transition: background 0.2s ease;
        }

        .toggle.active {
            background: var(--console-color);
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: linear-gradient(180deg, #ffffff 0%, #e0e0e0 100%);
            border: 3px solid var(--pixel-black);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 0 rgba(0,0,0,0.2);
        }

        .toggle.active::after {
            transform: translateX(22px);
        }

        /* Decorative screws on console frame */

        .screw {
            position: absolute;
            width: 14px;
            height: 14px;
            background: linear-gradient(135deg, #909090 0%, #707070 50%, #505050 100%);
            border-radius: 50%;
            border: 2px solid #404040;
            z-index: 3;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .screw::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(45deg);
            width: 8px;
            height: 2px;
            background: #404040;
        }

        .screw-tl { top: 10px; left: 10px; }

        .screw-tr { top: 10px; right: 10px; }

        .screw-bl { bottom: 10px; left: 10px; }

        .screw-br { bottom: 10px; right: 10px; }

        @media (pointer: coarse) {
            .screw-tl { top: 80px; }
            .screw-tr { top: 80px; }
        }

        /* Hide controls slightly on desktop */

        @media (pointer: fine) {
            #controls {
                opacity: 0.4;
                transition: opacity 0.3s ease;
            }
            #controls:hover {
                opacity: 1;
            }
        }

        /* Mobile adjustments */

        @media (max-height: 680px) {
            #screen-container {
                max-height: 42%;
            }
            .arrow-btn {
                width: 58px;
                height: 58px;
            }
            #jump-btn {
                width: 72px;
                height: 72px;
            }
            #jump-btn::after {
                width: 40px;
                height: 40px;
            }
            .overlay-content {
                padding: 20px 18px;
            }
            .game-title {
                font-size: 0.9rem;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const f of r.addedNodes)f.tagName==="LINK"&&f.rel==="modulepreload"&&o(f)}).observe(document,{childList:!0,subtree:!0});function a(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function o(i){if(i.ep)return;i.ep=!0;const r=a(i);fetch(i.href,r)}})();const c={PLAYER_WIDTH:30,PLAYER_HEIGHT:35,PLAYER_SPEED:4.5,JUMP_VELOCITY:-13.5,DOUBLE_JUMP_VELOCITY:-11,GRAVITY:.6,GROUND_OFFSET:30,SQUASH_AMOUNT:.3,STRETCH_AMOUNT:.2,SQUASH_RECOVERY:.15,SAW_SIZE:45,SAW_SPEED:4.5,SAW_SPAWN_INTERVAL:1600,SAW_ROTATION_SPEED:.08,SAWS_PER_ROUND:8,MAX_SAWS_ON_SCREEN:10,COIN_SIZE:14,COIN_GRAVITY:.35,COIN_BOUNCE:.6,COINS_PER_SAW:5,COIN_SPREAD:50,COIN_LIFETIME:8e3,PARTICLE_COUNT:16,PARTICLE_LIFE:600,SHAKE_JUMP:2,SHAKE_LAND:4,SHAKE_EXPLOSION:8,SHAKE_DEATH:15,SHAKE_DECAY:.85,DANGER_ZONE_SPEED:.03,DANGER_ZONE_START:-80,POPUP_DURATION:1e3,BG_THEMES:[{bg:"#f0e6f5",skyline:"#d4c6df",accent:"#6a4a8f",ground:"#5a3a7a",console:"#6a4a8f",consoleDark:"#5a3a7a",consoleLight:"#7a5a9f",btnColor:"#f0e6f5",btnDark:"#d4c6df",spikeStyle:"neon"},{bg:"#e6f0f5",skyline:"#c6d4df",accent:"#4a6a8f",ground:"#3a5a7a",console:"#4a6a8f",consoleDark:"#3a5a7a",consoleLight:"#5a7a9f",btnColor:"#e6f0f5",btnDark:"#c6d4df",spikeStyle:"industrial"},{bg:"#f5e6e6",skyline:"#dfc6c6",accent:"#8f4a4a",ground:"#7a3a3a",console:"#8f4a4a",consoleDark:"#7a3a3a",consoleLight:"#9f5a5a",btnColor:"#f5e6e6",btnDark:"#dfc6c6",spikeStyle:"crystal"},{bg:"#e6f5e6",skyline:"#c6dfc6",accent:"#4a8f5a",ground:"#3a7a4a",console:"#4a8f5a",consoleDark:"#3a7a4a",consoleLight:"#5a9f6a",btnColor:"#e6f5e6",btnDark:"#c6dfc6",spikeStyle:"organic"},{bg:"#f5efe6",skyline:"#d4cfc6",accent:"#5a8f4a",ground:"#4a7a3a",console:"#5a8f4a",consoleDark:"#4a7a3a",consoleLight:"#6aa05a",btnColor:"#f5efe6",btnDark:"#d8d0c8",spikeStyle:"classic"},{bg:"#f5f0e6",skyline:"#dfd4c6",accent:"#8f6a4a",ground:"#7a5a3a",console:"#8f6a4a",consoleDark:"#7a5a3a",consoleLight:"#9f7a5a",btnColor:"#f5f0e6",btnDark:"#dfd4c6",spikeStyle:"steampunk"}]},q=document.getElementById("gameCanvas"),t=q.getContext("2d"),ze=document.getElementById("screen-container"),ae=document.getElementById("startScreen"),ce=document.getElementById("gameOverScreen"),U=document.getElementById("pauseScreen"),oe=document.getElementById("pauseBtn"),Ze=document.getElementById("settingsModal"),Xe=document.getElementById("scoreDisplay"),je=document.getElementById("roundDisplay"),pe=document.getElementById("score-badge"),ge=document.getElementById("round-badge"),Ke=document.getElementById("progress-bar"),Qe=document.getElementById("finalScore"),$e=document.getElementById("coinsCollected"),et=document.getElementById("leftBtn"),tt=document.getElementById("rightBtn"),nt=document.getElementById("jump-btn");let g="START",u=0,y=0;window.matchMedia("(pointer: coarse)").matches;let l={x:0,y:0,vx:0,vy:0,rotation:0,isJumping:!1,canDoubleJump:!0,hasDoubleJumped:!1,facingLeft:!1,squashX:1,squashY:1,runFrame:0,runTimer:0},v=[],N=[],x=[],Y=[],D=0,ne=0,M=1,X=0,m=0,R=c.DANGER_ZONE_START,ie=0,se=0,H=0,G=0,ke="#ffffff",J=!1,F=!1,z=!1,k=0,p={music:localStorage.getItem("sawDodge_music")!=="false",fx:localStorage.getItem("sawDodge_fx")!=="false",haptics:localStorage.getItem("sawDodge_haptics")!=="false"};function Q(e,n,a){return e+(n-e)*a}function at(e){return 1-(1-e)*(1-e)}function ot(e){return 1+2.70158*Math.pow(e-1,3)+1.70158*Math.pow(e-1,2)}let s=null,E=null;const it="https://assets.oasiz.ai/audio/dodge-song.mp3";function st(){s||(s=new AudioContext,console.log("[initAudio] Audio context initialized")),E||(E=new Audio(it),E.loop=!0,E.volume=.4,E.preload="auto",E.addEventListener("canplaythrough",()=>{console.log("[initAudio] Background music loaded")}),E.addEventListener("error",e=>{console.log("[initAudio] Error loading background music:",e)}))}function Oe(){!p.music||!E||(E.play().catch(e=>{console.log("[playBackgroundMusic] Autoplay blocked, will play on interaction:",e)}),console.log("[playBackgroundMusic] Background music started"))}function lt(){E&&(E.pause(),console.log("[pauseBackgroundMusic] Background music paused"))}function He(){E&&(E.pause(),E.currentTime=0,console.log("[stopBackgroundMusic] Background music stopped"))}function ct(){E&&(p.music&&g==="PLAYING"?E.paused&&E.play().catch(()=>{}):E.pause())}function rt(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createGain();e.connect(n),n.connect(s.destination),e.type="square",e.frequency.setValueAtTime(220,s.currentTime),e.frequency.exponentialRampToValueAtTime(440,s.currentTime+.08),n.gain.setValueAtTime(.12,s.currentTime),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+.12),e.start(s.currentTime),e.stop(s.currentTime+.12)}function ft(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createGain();e.connect(n),n.connect(s.destination),e.type="triangle",e.frequency.setValueAtTime(100,s.currentTime),e.frequency.exponentialRampToValueAtTime(60,s.currentTime+.08),n.gain.setValueAtTime(.15,s.currentTime),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+.1),e.start(s.currentTime),e.stop(s.currentTime+.1)}function dt(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createOscillator(),a=s.createGain();e.connect(a),n.connect(a),a.connect(s.destination),e.type="sawtooth",e.frequency.setValueAtTime(200,s.currentTime),e.frequency.exponentialRampToValueAtTime(40,s.currentTime+.25),n.type="square",n.frequency.setValueAtTime(150,s.currentTime),n.frequency.exponentialRampToValueAtTime(30,s.currentTime+.3),a.gain.setValueAtTime(.2,s.currentTime),a.gain.exponentialRampToValueAtTime(.01,s.currentTime+.3),e.start(s.currentTime),n.start(s.currentTime),e.stop(s.currentTime+.3),n.stop(s.currentTime+.3)}function ut(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createGain();e.connect(n),n.connect(s.destination),e.type="sine",e.frequency.setValueAtTime(880,s.currentTime),e.frequency.exponentialRampToValueAtTime(1320,s.currentTime+.06),n.gain.setValueAtTime(.1,s.currentTime),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+.1),e.start(s.currentTime),e.stop(s.currentTime+.1)}function ht(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createGain();e.connect(n),n.connect(s.destination),e.type="sawtooth",e.frequency.setValueAtTime(400,s.currentTime),e.frequency.exponentialRampToValueAtTime(80,s.currentTime+.5),n.gain.setValueAtTime(.2,s.currentTime),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+.5),e.start(s.currentTime),e.stop(s.currentTime+.5)}function mt(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume(),[523,659,784,1047].forEach((n,a)=>{const o=s.createOscillator(),i=s.createGain();o.connect(i),i.connect(s.destination),o.type="square",o.frequency.setValueAtTime(n,s.currentTime+a*.1),i.gain.setValueAtTime(.1,s.currentTime+a*.1),i.gain.exponentialRampToValueAtTime(.01,s.currentTime+a*.1+.2),o.start(s.currentTime+a*.1),o.stop(s.currentTime+a*.1+.2)})}function Z(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createGain();e.connect(n),n.connect(s.destination),e.type="square",e.frequency.setValueAtTime(800,s.currentTime),n.gain.setValueAtTime(.06,s.currentTime),n.gain.exponentialRampToValueAtTime(.01,s.currentTime+.03),e.start(s.currentTime),e.stop(s.currentTime+.03)}function S(e){p.haptics&&typeof window.triggerHaptic=="function"&&window.triggerHaptic(e)}function C(e){H=Math.max(H,e)}function re(e,n=1){G=n,ke=e}function pt(){H>.1?(ie=(Math.random()-.5)*H*2,se=(Math.random()-.5)*H*2,H*=c.SHAKE_DECAY):(ie=0,se=0,H=0),G>0&&(G*=.85,G<.05&&(G=0))}function Ne(){const e=c.BG_THEMES[(M-1)%c.BG_THEMES.length],n=document.documentElement;n.style.setProperty("--console-color",e.console),n.style.setProperty("--console-color-dark",e.consoleDark),n.style.setProperty("--console-color-light",e.consoleLight),n.style.setProperty("--console-btn-color",e.btnColor),n.style.setProperty("--console-btn-dark",e.btnDark),n.style.setProperty("--screen-bg",e.bg),console.log("[applyTheme] Theme applied for round "+M+": "+e.spikeStyle)}function gt(){const e=c.BG_THEMES[(M-1)%c.BG_THEMES.length],n=t.createLinearGradient(0,0,0,y);n.addColorStop(0,e.bg),n.addColorStop(.7,e.skyline),n.addColorStop(1,e.skyline),t.fillStyle=n,t.fillRect(0,0,u,y),yt(e),St(e),Tt(e),R>0&&Et()}function yt(e){t.fillStyle=e.skyline,t.globalAlpha=.4,t.beginPath(),t.moveTo(0,m),[{x:0,y:m-y*.15},{x:u*.15,y:m-y*.25},{x:u*.3,y:m-y*.18},{x:u*.45,y:m-y*.3},{x:u*.6,y:m-y*.2},{x:u*.75,y:m-y*.28},{x:u*.9,y:m-y*.15},{x:u,y:m-y*.22}].forEach(a=>t.lineTo(a.x,a.y)),t.lineTo(u,m),t.closePath(),t.fill(),t.globalAlpha=1}function St(e){const n=m,a=[{x:.02,w:.06,h:.2},{x:.1,w:.05,h:.28},{x:.17,w:.08,h:.18},{x:.28,w:.04,h:.32},{x:.35,w:.07,h:.24},{x:.48,w:.05,h:.35},{x:.58,w:.08,h:.2},{x:.7,w:.05,h:.28},{x:.8,w:.06,h:.22},{x:.9,w:.07,h:.26}];t.fillStyle=e.skyline,t.globalAlpha=.5,a.forEach(o=>{const i=o.x*u,r=o.w*u,f=o.h*y*.4;t.fillRect(i,n-f,r,f),t.fillStyle=e.bg,t.globalAlpha=.3;for(let d=n-f+8;d<n-8;d+=12)for(let h=i+4;h<i+r-4;h+=8)t.fillRect(h,d,4,6);t.fillStyle=e.skyline,t.globalAlpha=.5}),t.globalAlpha=1}function Tt(e){t.fillStyle=e.accent,t.fillRect(0,m,u,y-m),t.fillStyle=e.ground,t.fillRect(0,m+4,u,y-m-4),t.fillStyle=e.accent;for(let n=0;n<u;n+=8){const a=3+Math.sin(n*.5+k*.001)*2;t.fillRect(n,m-a,3,a)}}function Et(){const e=t.createLinearGradient(0,0,0,R+40);e.addColorStop(0,"#c84040"),e.addColorStop(.8,"#c84040"),e.addColorStop(1,"rgba(200, 64, 64, 0)"),t.fillStyle=e,t.fillRect(0,0,u,R+40),t.fillStyle="#c84040";for(let n=0;n<u;n+=12){const a=n*.4+k*.003,o=Math.sin(a)*12+18,i=6+Math.sin(a*.7)*2;t.beginPath(),t.moveTo(n,R),t.lineTo(n+i,R),t.lineTo(n+i/2,R+o),t.closePath(),t.fill()}t.fillStyle="#ffcc00",t.globalAlpha=.3;for(let n=0;n<u;n+=20){const a=k*.05%20;t.fillRect(n-a,R-4,10,4)}t.globalAlpha=1}function ye(){const e=l.x,n=l.y,a=c.PLAYER_WIDTH,o=c.PLAYER_HEIGHT;t.save();const i=e+a/2,r=n+o/2;t.translate(i,r),l.facingLeft&&t.scale(-1,1),t.rotate(l.rotation),t.scale(l.squashX,l.squashY),t.translate(-a/2,-o/2);const f="#40a0ff",d="#80c0ff",h="#2060c0",T="#b0e0ff",L=Math.sin(k*.008)*1.5,w=Math.sin(l.runTimer*.02);t.fillStyle=f,t.beginPath(),t.roundRect(0,2+L,a,o-6,12),t.fill(),t.fillStyle=d,t.beginPath(),t.roundRect(4,4+L,a-8,8,6),t.fill(),t.fillStyle=h;const A=o-4,P=6,b=6;if(l.isJumping)t.fillRect(4,A-2,P,b),t.fillRect(a-10,A-2,P,b);else if(Math.abs(l.vx)>.5){const B=w*5;t.fillRect(6+B,A+Math.abs(B)*.2,P,b),t.fillRect(a-12-B,A+Math.abs(B)*.2,P,b)}else t.fillRect(6,A,P,b),t.fillRect(a-12,A,P,b);const I=12+L*.5,O=7;t.fillStyle="#ffffff",t.beginPath(),t.arc(8,I,O,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a-8,I,O,0,Math.PI*2),t.fill(),t.fillStyle="#1a1a2e";const _=l.vx*.4;t.beginPath(),t.arc(8+_,I+1,3.5,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a-8+_,I+1,3.5,0,Math.PI*2),t.fill(),t.fillStyle="#ffffff",t.beginPath(),t.arc(6+_,I-1,1.5,0,Math.PI*2),t.fill(),t.beginPath(),t.arc(a-10+_,I-1,1.5,0,Math.PI*2),t.fill(),t.fillStyle="#ff90a0",t.globalAlpha=.4,t.beginPath(),t.ellipse(4,I+6,4,2,0,0,Math.PI*2),t.fill(),t.beginPath(),t.ellipse(a-4,I+6,4,2,0,0,Math.PI*2),t.fill(),t.globalAlpha=1,t.strokeStyle=h,t.lineWidth=2,t.lineCap="round",l.hasDoubleJumped&&l.rotation!==0?(t.fillStyle=h,t.beginPath(),t.arc(a/2,I+8,3,0,Math.PI*2),t.fill()):(t.beginPath(),t.arc(a/2,I+6,4,.2,Math.PI-.2),t.stroke()),l.hasDoubleJumped&&l.isJumping&&(t.globalAlpha=.3+Math.sin(k*.02)*.2,t.fillStyle=T,t.beginPath(),t.arc(a/2,o/2,a,0,Math.PI*2),t.fill(),t.globalAlpha=1),t.restore()}function Se(e){const n=e.x,a=e.y,o=c.SAW_SIZE/2*e.scale;if(t.save(),t.translate(n,a),t.rotate(e.rotation),e.glowIntensity>0){let h="rgba(255, 100, 100, ";e.style==="crystal"&&(h="rgba(100, 200, 255, "),e.style==="neon"&&(h="rgba(255, 0, 255, ");const T=t.createRadialGradient(0,0,0,0,0,o*1.5);T.addColorStop(0,h+e.glowIntensity*.5+")"),T.addColorStop(1,h+"0)"),t.fillStyle=T,t.beginPath(),t.arc(0,0,o*1.5,0,Math.PI*2),t.fill()}let i="#404040",r="#606060",f="#505050",d=10;if(e.exploding)i="#ff4040",r="#ffff40",f="#ffffff";else switch(e.style){case"industrial":i="#2a2a2a",r="#808080",f="#3a3a3a",d=8;break;case"crystal":i="#40a0ff",r="#a0d0ff",f="#ffffff",d=6;break;case"organic":i="#4a7a3a",r="#6aa05a",f="#2a4a1a",d=12;break;case"neon":i="#ff00ff",r="#ffffff",f="#000000",d=10;break;case"steampunk":i="#8b4513",r="#daa520",f="#cd7f32",d=14;break}t.fillStyle=i,t.beginPath();for(let h=0;h<d;h++){const T=h/d*Math.PI*2,L=(h+.5)/d*Math.PI*2,w=o,A=o*(e.style==="crystal"?.5:.7);h===0&&t.moveTo(Math.cos(T)*w,Math.sin(T)*w),t.lineTo(Math.cos(L)*A,Math.sin(L)*A);const P=(h+1)/d*Math.PI*2;t.lineTo(Math.cos(P)*w,Math.sin(P)*w)}if(t.closePath(),t.fill(),e.style==="steampunk"&&!e.exploding){t.strokeStyle="#daa520",t.lineWidth=2,t.stroke(),t.fillStyle="#cd7f32";for(let h=0;h<4;h++){const T=h/4*Math.PI*2;t.beginPath(),t.arc(Math.cos(T)*o*.4,Math.sin(T)*o*.4,3,0,Math.PI*2),t.fill()}}else e.style==="neon"&&!e.exploding&&(t.strokeStyle="#ffffff",t.lineWidth=3,t.stroke(),t.shadowBlur=10,t.shadowColor="#ff00ff");t.fillStyle=r,t.beginPath(),t.arc(0,0,o*.35,0,Math.PI*2),t.fill(),t.fillStyle=f,t.beginPath(),t.arc(0,0,o*.15,0,Math.PI*2),t.fill(),t.restore()}function Te(e){if(e.collected)return;const n=e.x,a=e.y+Math.sin(e.bobOffset+k*.005)*3,o=c.COIN_SIZE/2,i=c.COIN_LIFETIME*.7;let r=1;if(e.lifetime<i&&(r=e.lifetime/i),t.save(),t.globalAlpha=r,t.translate(n,a),e.sparkle>0){t.fillStyle="#ffffff",t.globalAlpha=e.sparkle*r;for(let d=0;d<4;d++){const h=d/4*Math.PI*2+k*.01,T=o*1.5;t.fillRect(Math.cos(h)*T-2,Math.sin(h)*T-2,4,4)}t.globalAlpha=r}const f=t.createRadialGradient(-o*.3,-o*.3,0,0,0,o);f.addColorStop(0,"#fff700"),f.addColorStop(.5,"#ffd700"),f.addColorStop(1,"#b8860b"),t.fillStyle=f,t.beginPath(),t.arc(0,0,o,0,Math.PI*2),t.fill(),t.strokeStyle="#8b6914",t.lineWidth=2,t.stroke(),t.fillStyle="#b8860b",t.fillRect(-2,-o*.5,4,o),t.fillRect(-o*.5,-2,o,4),t.restore()}function At(e){const n=e.life/e.maxLife;if(t.save(),t.globalAlpha=n,t.translate(e.x,e.y),t.rotate(e.rotation),e.type==="star"){t.fillStyle=e.color;const a=e.size*n;t.beginPath();for(let o=0;o<5;o++){const i=o/5*Math.PI*2-Math.PI/2,r=i+Math.PI/5;t.lineTo(Math.cos(i)*a,Math.sin(i)*a),t.lineTo(Math.cos(r)*a*.4,Math.sin(r)*a*.4)}t.closePath(),t.fill()}else{const a=e.size*n;t.fillStyle=e.color,t.fillRect(-a/2,-a/2,a,a)}t.restore()}function Ee(){for(const e of x)At(e)}function Ae(){for(const e of Y){const n=1-e.life/e.maxLife,a=1-at(n),o=e.y-n*30,i=1+ot(Math.min(n*3,1))*.3;t.save(),t.globalAlpha=a,t.translate(e.x,o),t.scale(i,i),t.font="bold 14px 'Press Start 2P', monospace",t.textAlign="center",t.textBaseline="middle",t.fillStyle="#000000",t.fillText(e.value,1,1),t.fillStyle=e.color,t.fillText(e.value,0,0),t.restore()}}function Me(){G>0&&(t.fillStyle=ke,t.globalAlpha=G*.4,t.fillRect(0,0,u,y),t.globalAlpha=1)}let $=-1,ee=-1;function Ie(){D!==$&&(Xe.textContent=D.toString(),$!==-1&&(pe.classList.add("pop"),setTimeout(()=>pe.classList.remove("pop"),120)),$=D),M!==ee&&(je.textContent=M.toString(),ee!==-1&&(ge.classList.add("pop"),setTimeout(()=>ge.classList.remove("pop"),200)),ee=M);const e=X/c.SAWS_PER_ROUND*100;Ke.style.width=e+"%"}function fe(e,n,a,o){Y.push({x:e,y:n,value:a,life:c.POPUP_DURATION,maxLife:c.POPUP_DURATION,color:o})}function Mt(e,n){const a=["#ff6060","#ff8040","#ffff40","#ffffff"];for(let o=0;o<c.PARTICLE_COUNT;o++){const i=o/c.PARTICLE_COUNT*Math.PI*2+Math.random()*.3,r=4+Math.random()*6,f=Math.random()>.6;x.push({x:e,y:n,vx:Math.cos(i)*r,vy:Math.sin(i)*r-2,life:c.PARTICLE_LIFE+Math.random()*200,maxLife:c.PARTICLE_LIFE+Math.random()*200,size:f?8+Math.random()*6:5+Math.random()*5,color:a[Math.floor(Math.random()*a.length)],type:f?"star":"explosion",rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}}function It(e,n){const a=c.BG_THEMES[(M-1)%c.BG_THEMES.length];for(let o=0;o<6;o++){const i=Math.PI+(Math.random()-.5)*Math.PI*.8,r=1+Math.random()*2;x.push({x:e+(Math.random()-.5)*c.PLAYER_WIDTH,y:n,vx:Math.cos(i)*r,vy:Math.sin(i)*r-1,life:300+Math.random()*200,maxLife:400,size:4+Math.random()*4,color:a.accent,type:"dust",rotation:0,rotationSpeed:0})}}function Pt(e,n){for(let a=0;a<8;a++){const o=a/8*Math.PI*2,i=2+Math.random()*3;x.push({x:e,y:n,vx:Math.cos(o)*i,vy:Math.sin(o)*i,life:300,maxLife:300,size:4,color:"#ffd700",type:"star",rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.3})}}function xt(e){const n=l.isJumping,a=(J?-1:0)+(F?1:0);l.vx=Q(l.vx,a*c.PLAYER_SPEED,.3),l.vx<-.1?l.facingLeft=!0:l.vx>.1&&(l.facingLeft=!1),l.x+=l.vx,l.x<0&&(l.x=0),l.x+c.PLAYER_WIDTH>u&&(l.x=u-c.PLAYER_WIDTH),Math.abs(l.vx)>.5&&!l.isJumping&&(l.runTimer+=e,l.runTimer>100&&(l.runFrame=(l.runFrame+1)%4,l.runTimer=0)),l.hasDoubleJumped&&l.rotation<Math.PI*2&&(l.rotation+=.3,l.rotation>Math.PI*2&&(l.rotation=Math.PI*2)),l.vy+=c.GRAVITY,!z&&l.vy<-2&&(l.vy*=.65),l.y+=l.vy,l.y+c.PLAYER_HEIGHT>=m&&(l.y=m-c.PLAYER_HEIGHT,l.rotation=0,n&&l.vy>2&&(l.squashX=1+c.SQUASH_AMOUNT,l.squashY=1-c.SQUASH_AMOUNT,C(c.SHAKE_LAND),It(l.x+c.PLAYER_WIDTH/2,m),ft(),S("light"),bt()),l.vy=0,l.isJumping=!1,l.canDoubleJump=!0,l.hasDoubleJumped=!1),l.squashX=Q(l.squashX,1,c.SQUASH_RECOVERY),l.squashY=Q(l.squashY,1,c.SQUASH_RECOVERY),R>l.y+5&&Ge()}function Pe(){g==="PLAYING"&&(l.isJumping?l.canDoubleJump&&!l.hasDoubleJumped&&(l.vy=c.DOUBLE_JUMP_VELOCITY,l.hasDoubleJumped=!0,l.canDoubleJump=!1,l.rotation=0,l.squashX=1-c.STRETCH_AMOUNT*.7,l.squashY=1+c.STRETCH_AMOUNT*.7,_t(l.x+c.PLAYER_WIDTH/2,l.y+c.PLAYER_HEIGHT/2),C(c.SHAKE_JUMP*1.3),Rt(),S("medium"),console.log("[jump] Player double jumped and flipped!")):(l.vy=c.JUMP_VELOCITY,l.isJumping=!0,l.canDoubleJump=!0,l.hasDoubleJumped=!1,l.squashX=1-c.STRETCH_AMOUNT,l.squashY=1+c.STRETCH_AMOUNT,Lt(l.x+c.PLAYER_WIDTH/2,m),C(c.SHAKE_JUMP),rt(),S("light"),console.log("[jump] Player jumped")))}function Lt(e,n){const a=c.BG_THEMES[(M-1)%c.BG_THEMES.length];for(let o=0;o<10;o++){const i=Math.PI+(Math.random()-.5)*Math.PI*.7,r=2+Math.random()*3;x.push({x:e+(Math.random()-.5)*c.PLAYER_WIDTH,y:n-2,vx:Math.cos(i)*r,vy:Math.sin(i)*r-2,life:400,maxLife:400,size:6+Math.random()*5,color:a.accent,type:"dust",rotation:0,rotationSpeed:0})}}function _t(e,n){const a=["#60a8ff","#80c8ff","#ffffff","#4080e0"];for(let o=0;o<16;o++){const i=o/16*Math.PI*2,r=4+Math.random()*2.5;x.push({x:e+Math.cos(i)*12,y:n+Math.sin(i)*10,vx:Math.cos(i)*r,vy:Math.sin(i)*r,life:450,maxLife:450,size:6+Math.random()*5,color:a[o%a.length],type:"star",rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.35})}for(let o=0;o<8;o++)x.push({x:e+(Math.random()-.5)*24,y:n+10,vx:(Math.random()-.5)*2,vy:4+Math.random()*4,life:350,maxLife:350,size:7+Math.random()*5,color:"#80c8ff",type:"dust",rotation:0,rotationSpeed:0});for(let o=0;o<6;o++){const i=o/6*Math.PI*2+Math.PI/6;x.push({x:e,y:n,vx:Math.cos(i)*6,vy:Math.sin(i)*6-2,life:300,maxLife:300,size:4,color:"#ffffff",type:"star",rotation:Math.random()*Math.PI*2,rotationSpeed:.4})}}function Rt(){if(!p.fx||!s)return;s.state==="suspended"&&s.resume();const e=s.createOscillator(),n=s.createOscillator(),a=s.createGain();e.connect(a),n.connect(a),a.connect(s.destination),e.type="sine",e.frequency.setValueAtTime(400,s.currentTime),e.frequency.exponentialRampToValueAtTime(800,s.currentTime+.12),n.type="triangle",n.frequency.setValueAtTime(600,s.currentTime),n.frequency.exponentialRampToValueAtTime(1200,s.currentTime+.12),a.gain.setValueAtTime(.1,s.currentTime),a.gain.exponentialRampToValueAtTime(.01,s.currentTime+.15),e.start(s.currentTime),n.start(s.currentTime),e.stop(s.currentTime+.15),n.stop(s.currentTime+.15)}function vt(){const e=Math.random()*(u-c.SAW_SIZE*2)+c.SAW_SIZE,n=c.SAW_SPEED+(M-1)*.15,a=c.BG_THEMES[(M-1)%c.BG_THEMES.length],o=(Math.random()*.6+.2)*Math.PI,i=Math.cos(o)*n*(Math.random()>.5?1:-1),r=Math.abs(Math.sin(o)*n);v.push({x:e,y:-45,vx:i,vy:r,speed:n,rotation:Math.random()*Math.PI*2,jumpedOver:!1,passed:!1,hasHitGround:!1,exploding:!1,explodeTimer:0,scale:1,glowIntensity:0,style:a.spikeStyle}),console.log("[spawnSaw] Spawned saw at x="+e.toFixed(0)+" with style "+a.spikeStyle)}function wt(e){const n=c.SAW_SIZE/2;for(let a=v.length-1;a>=0;a--){const o=v[a];if(o.exploding){if(o.explodeTimer-=e,o.rotation+=c.SAW_ROTATION_SPEED*4,o.scale=Q(o.scale,0,.1),o.glowIntensity=o.explodeTimer/400,o.explodeTimer<=0){v.splice(a,1);continue}}else{if(o.x+=o.vx,o.y+=o.vy,o.rotation+=c.SAW_ROTATION_SPEED*(Math.abs(o.vx)+Math.abs(o.vy))*.3,o.x-n<=0&&(o.x=n,o.vx=Math.abs(o.vx),C(2),S("light")),o.x+n>=u&&(o.x=u-n,o.vx=-Math.abs(o.vx),C(2),S("light")),o.y-n<=0&&!o.hasHitGround&&(o.y=n,o.vy=Math.abs(o.vy),C(2),S("light")),o.y+n<-50&&o.hasHitGround){v.splice(a,1);continue}if(o.y+n>=m&&(o.y=m-n,o.vy=-Math.abs(o.vy),o.hasHitGround=!0,C(3),S("light")),!o.jumpedOver&&!o.passed&&l.isJumping){const i=l.y+c.PLAYER_HEIGHT,r=l.x,f=l.x+c.PLAYER_WIDTH,d=o.y-n,h=o.x-n,T=o.x+n,L=f>h&&r<T,w=i<d+10;L&&w&&(o.jumpedOver=!0,o.glowIntensity=.5,console.log("[updateSaws] Player jumped over saw!"))}if(!o.passed&&Dt(o)){Ge();return}}}}function bt(){for(let e=v.length-1;e>=0;e--){const n=v[e];n.jumpedOver&&!n.passed&&!n.exploding&&(n.passed=!0,D++,X++,n.exploding=!0,n.explodeTimer=400,n.glowIntensity=1,C(c.SHAKE_EXPLOSION),re("#ff8040",.8),dt(),S("medium"),Mt(n.x,n.y),Ct(n.x,n.y),fe(n.x,n.y-20,"+1","#ffffff"),console.log("[onPlayerLand] Saw dodged on landing! Score: "+D),X>=c.SAWS_PER_ROUND&&Nt())}}function Dt(e){const n=l.x+c.PLAYER_WIDTH/2,a=l.y+c.PLAYER_HEIGHT/2,o=n-e.x,i=a-e.y,r=Math.sqrt(o*o+i*i),f=c.SAW_SIZE/2*.7+Math.min(c.PLAYER_WIDTH,c.PLAYER_HEIGHT)/3;return r<f}function Ct(e,n){for(let a=0;a<c.COINS_PER_SAW;a++){const o=(a/c.COINS_PER_SAW-.5)*Math.PI*.8-Math.PI/2,i=Math.cos(o)*c.COIN_SPREAD*(.6+Math.random()*.4),r=Math.sin(o)*c.COIN_SPREAD*.5;N.push({x:e+i,y:n+r,vy:-6-Math.random()*4,collected:!1,rotation:Math.random()*Math.PI*2,onGround:!1,lifetime:c.COIN_LIFETIME,bobOffset:Math.random()*Math.PI*2,sparkle:1})}}function kt(e){for(let n=N.length-1;n>=0;n--){const a=N[n];if(a.collected){N.splice(n,1);continue}if(a.sparkle=Math.max(0,a.sparkle-e*.002),a.lifetime-=e,a.lifetime<=0){N.splice(n,1);continue}a.onGround||(a.vy+=c.COIN_GRAVITY,a.y+=a.vy,a.y+c.COIN_SIZE/2>=m&&(a.y=m-c.COIN_SIZE/2,a.vy=-a.vy*c.COIN_BOUNCE,Math.abs(a.vy)<1.5&&(a.onGround=!0,a.vy=0))),Ot(a)&&(a.collected=!0,ne++,ut(),S("light"),Pt(a.x,a.y),fe(a.x,a.y,"+1","#ffd700"))}}function Ot(e){const n=l.x+c.PLAYER_WIDTH/2,a=l.y+c.PLAYER_HEIGHT/2,o=n-e.x,i=a-e.y;return Math.sqrt(o*o+i*i)<c.COIN_SIZE+c.PLAYER_WIDTH/2}function xe(e){for(let n=x.length-1;n>=0;n--){const a=x[n];a.x+=a.vx,a.y+=a.vy,a.vy+=.15,a.vx*=.98,a.rotation+=a.rotationSpeed,a.life-=e,a.life<=0&&x.splice(n,1)}}function Le(e){for(let n=Y.length-1;n>=0;n--)Y[n].life-=e,Y[n].life<=0&&Y.splice(n,1)}function Ht(){R+=c.DANGER_ZONE_SPEED}function Nt(){M++,X=0,R=c.DANGER_ZONE_START,Ne(),re("#ffffff",1),C(10),mt(),S("success"),fe(u/2,y/3,"ROUND "+M+"!","#ffffff"),console.log("[nextRound] Starting round "+M);const e=c.BG_THEMES[(M-1)%c.BG_THEMES.length];for(let n=0;n<30;n++)x.push({x:Math.random()*u,y:y+20,vx:(Math.random()-.5)*4,vy:-8-Math.random()*8,life:1200,maxLife:1200,size:8+Math.random()*6,color:n%2===0?e.accent:"#ffffff",type:"star",rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.1})}function Gt(){console.log("[resetGame] Resetting game state"),D=0,ne=0,M=1,X=0,R=c.DANGER_ZONE_START,k=0,Ne(),v=[],N=[],x=[],Y=[],H=0,G=0,$=-1,ee=-1,l.x=u/2-c.PLAYER_WIDTH/2,l.y=m-c.PLAYER_HEIGHT,l.vx=0,l.vy=0,l.rotation=0,l.isJumping=!1,l.canDoubleJump=!0,l.hasDoubleJumped=!1,l.facingLeft=!1,l.squashX=1,l.squashY=1,l.runFrame=0}function Ge(){g="GAME_OVER",console.log("[gameOver] Final score: "+D+", Coins: "+ne),typeof window.submitScore=="function"&&(window.submitScore(D),console.log("[gameOver] Score submitted: "+D)),C(c.SHAKE_DEATH),re("#ff0000",1);for(let e=0;e<25;e++){const n=e/25*Math.PI*2,a=3+Math.random()*5;x.push({x:l.x+c.PLAYER_WIDTH/2,y:l.y+c.PLAYER_HEIGHT/2,vx:Math.cos(n)*a,vy:Math.sin(n)*a-3,life:800,maxLife:800,size:6+Math.random()*6,color:e%3===0?"#40a0ff":e%3===1?"#80c0ff":"#ffffff",type:"explosion",rotation:Math.random()*Math.PI*2,rotationSpeed:(Math.random()-.5)*.2})}ht(),S("error"),He(),Qe.textContent=D.toString(),$e.textContent=ne+" COINS",ae.classList.add("hidden"),U.classList.add("hidden"),ce.classList.remove("hidden"),oe.classList.add("hidden")}function K(){console.log("[startGame] Starting game"),g="PLAYING",Yt(),st(),Gt(),ae.classList.add("hidden"),ce.classList.add("hidden"),U.classList.add("hidden"),oe.classList.remove("hidden"),Z(),S("light"),Oe()}function _e(){g==="PLAYING"&&(console.log("[pauseGame] Game paused"),g="PAUSED",U.classList.remove("hidden"),S("light"),lt())}function Re(){g==="PAUSED"&&(console.log("[resumeGame] Game resumed"),g="PLAYING",U.classList.add("hidden"),S("light"),Oe())}function le(){console.log("[showStartScreen] Showing start screen"),g="START",ae.classList.remove("hidden"),ce.classList.add("hidden"),U.classList.add("hidden"),oe.classList.add("hidden"),Ye(),He()}function Bt(){window.addEventListener("keydown",i=>{(i.key==="ArrowLeft"||i.key==="a"||i.key==="A")&&(J=!0,g==="PLAYING"&&S("light")),(i.key==="ArrowRight"||i.key==="d"||i.key==="D")&&(F=!0,g==="PLAYING"&&S("light")),(i.key===" "||i.key==="ArrowUp"||i.key==="w"||i.key==="W")&&(i.preventDefault(),z=!0,g==="PLAYING"?Pe():g==="START"&&K()),i.key==="Escape"&&(g==="PLAYING"?_e():g==="PAUSED"&&Re())}),window.addEventListener("keyup",i=>{(i.key==="ArrowLeft"||i.key==="a"||i.key==="A")&&(J=!1),(i.key==="ArrowRight"||i.key==="d"||i.key==="D")&&(F=!1),(i.key===" "||i.key==="ArrowUp"||i.key==="w"||i.key==="W")&&(z=!1)});function e(i,r,f){i.addEventListener("touchstart",d=>{d.preventDefault(),r(),i.classList.add("pressed")}),i.addEventListener("touchend",d=>{d.preventDefault(),f(),i.classList.remove("pressed")}),i.addEventListener("touchcancel",d=>{d.preventDefault(),f(),i.classList.remove("pressed")}),i.addEventListener("mousedown",d=>{d.preventDefault(),r(),i.classList.add("pressed")}),i.addEventListener("mouseup",d=>{d.preventDefault(),f(),i.classList.remove("pressed")}),i.addEventListener("mouseleave",()=>{f(),i.classList.remove("pressed")})}e(et,()=>{J=!0,g==="PLAYING"&&S("light")},()=>{J=!1}),e(tt,()=>{F=!0,g==="PLAYING"&&S("light")},()=>{F=!1}),e(nt,()=>{z=!0,g==="PLAYING"&&Pe()},()=>{z=!1}),document.getElementById("startButton").addEventListener("click",K),oe.addEventListener("click",_e),document.getElementById("resumeButton").addEventListener("click",Re),document.getElementById("pauseRestartBtn").addEventListener("click",()=>{U.classList.add("hidden"),K()}),document.getElementById("pauseMenuBtn").addEventListener("click",le),document.getElementById("restartButton").addEventListener("click",K),document.getElementById("menuButton").addEventListener("click",le);const n=document.getElementById("musicToggle"),a=document.getElementById("fxToggle"),o=document.getElementById("hapticToggle");n.classList.toggle("active",p.music),a.classList.toggle("active",p.fx),o.classList.toggle("active",p.haptics),n.addEventListener("click",()=>{p.music=!p.music,n.classList.toggle("active",p.music),localStorage.setItem("sawDodge_music",p.music.toString()),ct(),Z(),S("light")}),a.addEventListener("click",()=>{p.fx=!p.fx,a.classList.toggle("active",p.fx),localStorage.setItem("sawDodge_fx",p.fx.toString()),p.fx&&Z(),S("light")}),o.addEventListener("click",()=>{p.haptics=!p.haptics,o.classList.toggle("active",p.haptics),localStorage.setItem("sawDodge_haptics",p.haptics.toString()),Z(),S("light")}),document.getElementById("settingsClose").addEventListener("click",()=>{Ze.classList.add("hidden"),Z(),S("light")})}function ve(){const e=ze.getBoundingClientRect();u=e.width,y=e.height;const n=Math.min(window.devicePixelRatio||1,2);q.width=u*n,q.height=y*n,q.style.width=u+"px",q.style.height=y+"px",t.setTransform(n,0,0,n,0,0),t.imageSmoothingEnabled=!1,m=y-c.GROUND_OFFSET,l.y>m-c.PLAYER_HEIGHT&&(l.y=m-c.PLAYER_HEIGHT),console.log("[resizeCanvas] Canvas resized to: "+u+" x "+y)}let we=0,be=0,V=0;const W=1e3/60;function Be(e){const n=Math.min(e-we,100);if(we=e,k=e,V+=n,pt(),t.save(),t.translate(ie,se),t.clearRect(-20,-20,u+40,y+40),gt(),g==="PLAYING"){const a=v.filter(r=>!r.exploding).length,o=c.MAX_SAWS_ON_SCREEN+Math.floor((M-1)*.5),i=c.SAW_SPAWN_INTERVAL/(1+(M-1)*.1);for(e-be>i&&a<o&&(vt(),be=e);V>=W;)xt(W),wt(W),kt(W),Ht(),V-=W;xe(n),Le(n);for(const r of N)Te(r);for(const r of v)Se(r);ye(),Ee(),Ae(),Me(),Ie()}else if(g==="START")t.fillStyle="#ffffff",t.fillRect(0,0,u,y),V=0;else if(g==="PAUSED"||g==="GAME_OVER"){for(const a of N)Te(a);for(const a of v)Se(a);g==="PAUSED"&&ye(),Ee(),xe(n),Ae(),Le(n),Me(),Ie(),V=0}t.restore(),requestAnimationFrame(Be)}const de=document.getElementById("fallingSaws");let te=null;const De=[{main:"#c84040",teeth:"#e06060",core:"#802020"},{main:"#4080c8",teeth:"#60a0e0",core:"#205080"},{main:"#40c840",teeth:"#60e060",core:"#208020"},{main:"#c8a040",teeth:"#e0c060",core:"#806020"},{main:"#8040c8",teeth:"#a060e0",core:"#502080"},{main:"#c84080",teeth:"#e060a0",core:"#802050"},{main:"#40c8c8",teeth:"#60e0e0",core:"#208080"},{main:"#c86040",teeth:"#e08060",core:"#804020"}];function Ce(){const e=document.createElement("div");e.className="falling-saw";const n=ae.getBoundingClientRect(),a=n.width,o=n.height,i=30+Math.random()*45,r=Math.random()*(a-i),f=3+Math.random()*3,d=Math.random()*-f,h=.25+Math.random()*.45,T=6+Math.floor(Math.random()*6),L=De[Math.floor(Math.random()*De.length)],w=o+i+100;e.style.cssText="left: "+r+"px; width: "+i+"px; height: "+i+"px; animation-duration: "+f+"s; animation-delay: "+d+"s; opacity: "+h+"; --fall-distance: "+w+"px;";const A=document.createElementNS("http://www.w3.org/2000/svg","svg");A.setAttribute("viewBox","0 0 100 100"),A.setAttribute("width","100%"),A.setAttribute("height","100%");let P="";for(let _=0;_<T;_++){const B=_/T*Math.PI*2,ue=(_+.5)/T*Math.PI*2,he=(_+1)/T*Math.PI*2,j=45,me=30,Ue=50+Math.cos(B)*j,Ve=50+Math.sin(B)*j,We=50+Math.cos(ue)*me,qe=50+Math.sin(ue)*me,Je=50+Math.cos(he)*j,Fe=50+Math.sin(he)*j;_===0&&(P+="M "+Ue+" "+Ve+" "),P+="L "+We+" "+qe+" L "+Je+" "+Fe+" "}P+="Z";const b=document.createElementNS("http://www.w3.org/2000/svg","path");b.setAttribute("d",P),b.setAttribute("fill",L.main);const I=document.createElementNS("http://www.w3.org/2000/svg","circle");I.setAttribute("cx","50"),I.setAttribute("cy","50"),I.setAttribute("r","15"),I.setAttribute("fill",L.teeth);const O=document.createElementNS("http://www.w3.org/2000/svg","circle");O.setAttribute("cx","50"),O.setAttribute("cy","50"),O.setAttribute("r","6"),O.setAttribute("fill",L.core),A.appendChild(b),A.appendChild(I),A.appendChild(O),e.appendChild(A),de.appendChild(e),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},(f-d)*1e3+100)}function Ye(){console.log("[startFallingSaws] Starting falling saws animation"),de.innerHTML="";for(let e=0;e<12;e++)Ce();te=window.setInterval(()=>{g==="START"&&Ce()},400)}function Yt(){console.log("[stopFallingSaws] Stopping falling saws animation"),te!==null&&(clearInterval(te),te=null),de.innerHTML=""}function Ut(){console.log("[init] Initializing Saw Dodge"),ve(),window.addEventListener("resize",ve),Bt(),l.x=u/2-c.PLAYER_WIDTH/2,l.y=m-c.PLAYER_HEIGHT,requestAnimationFrame(Be),le(),Ye(),console.log("[init] Game initialized")}Ut();</script>
</head>
<body>
    <div id="game-container">
        <!-- Decorative screws -->
        <div class="screw screw-tl"></div>
        <div class="screw screw-tr"></div>
        <div class="screw screw-bl"></div>
        <div class="screw screw-br"></div>
        <!-- Pause Button -->
        <button id="pauseBtn" class="hidden">
            <svg viewBox="0 0 24 24">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
            </svg>
        </button>

        <!-- Game Screen -->
        <div id="screen-container">
            <canvas id="gameCanvas"></canvas>
        </div>

        <!-- HUD -->
        <div id="hud">
            <div class="hud-item" id="score-badge">
                <span class="hud-label">SCORE</span>
                <span class="hud-value" id="scoreDisplay">0</span>
            </div>
            <div class="hud-item" id="round-badge">
                <span class="hud-label">ROUND</span>
                <span class="hud-value" id="roundDisplay">1</span>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>

        <!-- Controls -->
        <div id="controls">
            <div id="dpad">
                <button class="arrow-btn" id="leftBtn">
                    <svg viewBox="0 0 24 24">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
                <button class="arrow-btn" id="rightBtn">
                    <svg viewBox="0 0 24 24">
                        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                    </svg>
                </button>
            </div>
            <button id="jump-btn"></button>
        </div>

        <!-- Start Screen - Full viewport with falling saws -->
        <div id="startScreen" class="overlay">
            <div class="falling-saws" id="fallingSaws"></div>
            <div class="overlay-content">
                <div class="title-container">
                    <svg class="title-saw saw-l" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="8" stroke-dasharray="10 10"/>
                        <circle cx="50" cy="50" r="10" fill="currentColor"/>
                    </svg>
                    <svg class="title-saw saw-r" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="40" fill="none" stroke="currentColor" stroke-width="8" stroke-dasharray="10 10"/>
                        <circle cx="50" cy="50" r="10" fill="currentColor"/>
                    </svg>
                    <h1 class="game-title">SAW DODGE</h1>
                    <p class="game-subtitle">Elite Handheld Edition</p>
                </div>

                <div class="instruction-box">
                    <div class="instruction-item">
                        <div class="instruction-dot"></div>
                        <span class="instructions">DODGE FALLING SPIKES</span>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-dot"></div>
                        <span class="instructions">JUMP FOR POINTS (+1)</span>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-dot"></div>
                        <span class="instructions">COLLECT GOLDEN COINS</span>
                    </div>
                    <div class="instruction-item">
                        <div class="instruction-dot"></div>
                        <span class="instructions">DOUBLE JUMP TO FLIP!</span>
                    </div>
                </div>

                <button class="btn" id="startButton">PRESS START</button>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="overlay-content">
                <h2 class="game-title">GAME OVER</h2>
                <p class="score-label">SAWS DODGED</p>
                <div class="final-score" id="finalScore">0</div>
                <p class="coins-collected" id="coinsCollected">0 COINS</p>
                <button class="btn" id="restartButton">RETRY</button>
                <button class="btn btn-secondary" id="menuButton">MENU</button>
            </div>
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="overlay hidden">
            <div class="overlay-content">
                <h2 class="game-title">PAUSED</h2>
                <button class="btn" id="resumeButton">RESUME</button>
                <button class="btn btn-secondary" id="pauseRestartBtn">RESTART</button>
                <button class="btn btn-secondary" id="pauseMenuBtn">MENU</button>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="settings-modal hidden">
            <h3 class="settings-title">SETTINGS</h3>
            <div class="settings-row">
                <span class="settings-label">MUSIC</span>
                <div class="toggle active" id="musicToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">SOUND FX</span>
                <div class="toggle active" id="fxToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">HAPTICS</span>
                <div class="toggle active" id="hapticToggle"></div>
            </div>
            <button class="btn" id="settingsClose">DONE</button>
        </div>
    </div>

</body>
</html>
