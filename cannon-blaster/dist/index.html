<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0f">
    <title>Cannon Blaster</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Russo+One&family=Orbitron:wght@400;700;900&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #0a0a0f;
            font-family: 'Russo One', 'Orbitron', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Game Container */

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px;
            max-height: 1000px;
            background: linear-gradient(180deg, #1a1f2e 0%, #0d1117 100%);
            overflow: hidden;
            border-radius: 16px;
            border: 4px solid #2d3a4a;
            box-shadow: 0 0 0 2px #1a2634, 0 20px 50px rgba(0, 0, 0, 0.6), inset 0 0 80px rgba(0, 50, 80, 0.1);
        }

        @media (pointer: coarse) {
            #game-container {
                max-width: none;
                max-height: none;
                border: none;
                border-radius: 0;
                box-shadow: none;
            }
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        /* ============= OVERLAYS ============= */

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            pointer-events: none;
            background: rgba(10, 15, 20, 0.92);
            backdrop-filter: blur(4px);
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .overlay:not(.hidden) {
            pointer-events: auto;
        }

        .content {
            text-align: center;
            padding: 30px;
            max-width: 90%;
        }

        /* ============= BUTTONS ============= */

        .btn {
            background: linear-gradient(180deg, #3d5a3d 0%, #2d4a2d 50%, #1d3a1d 100%);
            color: #c4e0c4;
            border: 3px solid #5a8a5a;
            padding: 16px 45px;
            font-family: 'Russo One', sans-serif;
            font-size: 1.3rem;
            letter-spacing: 2px;
            cursor: pointer;
            border-radius: 6px;
            box-shadow: 0 4px 0 #1a2a1a, 0 6px 20px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
            transition: all 0.1s ease;
            position: relative;
            text-transform: uppercase;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 #1a2a1a, 0 8px 25px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
            background: linear-gradient(180deg, #4d6a4d 0%, #3d5a3d 50%, #2d4a2d 100%);
        }

        .btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #1a2a1a, 0 3px 10px rgba(0,0,0,0.4), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .btn-secondary {
            background: transparent;
            border: 2px solid #4a5a6a;
            color: #8a9aaa;
            box-shadow: none;
            padding: 12px 30px;
            font-size: 1rem;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.05);
            border-color: #6a7a8a;
            color: #aabbcc;
            box-shadow: none;
            transform: none;
        }

        /* Top Bar */

        #top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 45px 15px 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 15;
            pointer-events: none;
        }

        @media (pointer: coarse) {
            #top-bar {
                padding-top: 120px;
            }
        }

        #hud {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex: 1;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #hud.hidden {
            opacity: 0;
        }

        .hud-left, .hud-right {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 50px;
        }

        .hud-left { text-align: left; }

        .hud-right { text-align: right; }

        .hud-label {
            font-size: 0.5rem;
            color: #5a7a6a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .hud-value {
            font-size: 1rem;
            font-weight: 900;
            color: #b4d4c4;
            font-family: 'Orbitron', monospace;
        }

        /* Progress Bar */

        .progress-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            width: 70px;
        }

        .progress-bar-bg {
            width: 100%;
            height: 6px;
            background: #1a2a2a;
            border: 1px solid #3a5a5a;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #4a8a4a, #6aba6a);
            transition: width 0.2s ease-out;
        }

        .progress-text {
            font-size: 0.55rem;
            color: #6a9a7a;
            font-family: 'Orbitron', monospace;
        }

        /* Buttons */

        .hud-btn {
            width: 38px;
            height: 38px;
            background: rgba(30, 40, 50, 0.8);
            border: 2px solid #4a5a6a;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            flex-shrink: 0;
        }

        .hud-btn.hidden {
            display: none;
        }

        .hud-btn svg {
            width: 18px;
            height: 18px;
            fill: #8a9aaa;
        }

        /* ============= UPGRADE DOTS ============= */

        .upgrade-indicators {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 25px;
            z-index: 5;
            pointer-events: none;
        }

        .upgrade-dots {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .upgrade-dots .label {
            font-size: 0.6rem;
            color: #5a6a7a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dots-row {
            display: flex;
            gap: 4px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 2px solid #4a6a5a;
            background: transparent;
            transition: all 0.3s ease;
        }

        .dot.filled {
            background: #6aba6a;
            border-color: #8ada8a;
            box-shadow: 0 0 6px rgba(100, 180, 100, 0.5);
        }

        /* ============= START SCREEN ============= */

        #startScreen .title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            color: #c4e0c4;
            margin-bottom: 8px;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 0 0 20px rgba(100, 200, 150, 0.4), 0 4px 0 #1a3a2a;
        }

        #startScreen .subtitle {
            font-size: 1rem;
            color: #6a8a7a;
            margin-bottom: 30px;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        /* Demo Animation Container */

        .demo-container {
            width: 280px;
            height: 180px;
            background: linear-gradient(180deg, #1a2530 0%, #0d1520 100%);
            border: 3px solid #3a5a4a;
            border-radius: 12px;
            margin: 0 auto 30px auto;
            box-shadow: inset 0 0 30px rgba(0, 30, 50, 0.5), 0 4px 15px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
        }

        #demoCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .start-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        /* ============= SKILL TREE SCREEN ============= */

        #upgradeScreen {
            background: rgba(5, 8, 12, 0.98);
        }

        #upgradeScreen .content {
            width: 100%;
            height: 100%;
            max-width: none;
            padding: 50px 15px 80px 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        @media (pointer: coarse) {
            #upgradeScreen .content {
                padding-top: 130px;
            }
        }

        /* ============= TACTICAL SCHEMATIC SCREEN ============= */

        #upgradeScreen {
            background: radial-gradient(circle at center, #0a1520 0%, #05080c 100%);
            overflow: hidden;
        }

        #upgradeScreen .content {
            width: 100%;
            height: 100%;
            max-width: 100%;
            padding: 110px 10px 20px 10px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        @media (pointer: coarse) {
            #upgradeScreen .content {
                padding-top: 180px;
            }
        }

        /* Scanning Animation Overlay */

        .scanline-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, 
                transparent 50%, 
                rgba(144, 255, 170, 0.03) 50%
            );
            background-size: 100% 4px;
            pointer-events: none;
            z-index: 5;
            opacity: 0.5;
        }

        .scanning-bar {
            position: absolute;
            top: -10%;
            left: 0;
            width: 100%;
            height: 10%;
            background: linear-gradient(to bottom, 
                transparent, 
                rgba(144, 255, 170, 0.2), 
                transparent
            );
            pointer-events: none;
            z-index: 6;
            animation: scan 4s linear infinite;
        }

        @keyframes scan {
            0% { top: -10%; }
            100% { top: 110%; }
        }

        .upgrade-header {
            text-align: center;
            margin-bottom: 12px;
            position: relative;
            z-index: 10;
        }

        .upgrade-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            font-weight: 900;
            color: #90ffaa;
            text-transform: uppercase;
            letter-spacing: 6px;
            text-shadow: 0 0 20px rgba(144, 255, 170, 0.4);
            margin-bottom: 4px;
        }

        .upgrade-subtitle {
            font-size: 0.7rem;
            color: #4a6a5a;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* Schematic Layout */

        .schematic-grid {
            display: flex;
            justify-content: space-between;
            gap: 15px;
            flex: 1;
            position: relative;
            z-index: 10;
            margin-bottom: 15px;
            background-image: 
                linear-gradient(rgba(144, 255, 170, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(144, 255, 170, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            border: 1px solid rgba(144, 255, 170, 0.1);
            padding: 15px 5px;
            border-radius: 8px;
        }

        .pillar {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            align-items: center;
        }

        .pillar-label {
            font-family: 'Orbitron', sans-serif;
            font-size: 0.55rem;
            font-weight: 700;
            color: var(--p-color);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 2px;
            opacity: 0.7;
        }

        /* Node Styling */

        .node {
            width: 48px;
            height: 48px;
            background: #05080c;
            border: 2px solid #1a2a3a;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            z-index: 11;
        }

        .node::before {
            content: '';
            position: absolute;
            top: -10px;
            left: 50%;
            width: 2px;
            height: 10px;
            background: #1a2a3a;
            transform: translateX(-50%);
        }

        .node:first-of-type::before {
            display: none;
        }

        .node-icon {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.2rem;
            font-weight: 900;
            color: #1a2a3a;
        }

        /* Node States */

        .node.owned {
            border-color: var(--p-color);
            background: rgba(var(--p-rgb), 0.15);
            box-shadow: 0 0 15px rgba(var(--p-rgb), 0.3), inset 0 0 10px rgba(var(--p-rgb), 0.2);
        }

        .node.owned .node-icon {
            color: var(--p-color);
            text-shadow: 0 0 10px var(--p-color);
        }

        .node.available {
            border-color: #5a7a8a;
            border-style: solid;
            background: #0a1a2a;
            animation: node-pulse 2s infinite;
        }

        .node.available .node-icon {
            color: #4a6a7a;
        }

        .node.selected {
            border-color: #fff;
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.4);
        }

        .node.locked-branch {
            opacity: 0.4;
            filter: grayscale(0.8);
            border-color: #ff4444;
            cursor: not-allowed;
            animation: flicker-offline 0.5s infinite alternate;
        }

        @keyframes flicker-offline {
            0% { border-color: #ff4444; box-shadow: 0 0 5px rgba(255, 68, 68, 0.2); }
            100% { border-color: #880000; box-shadow: none; }
        }

        .node.locked-branch::after {
            content: 'Ã—';
            position: absolute;
            font-size: 2rem;
            color: #ff4444;
            font-weight: 100;
            opacity: 0.8;
        }

        .node.fog {
            opacity: 0.1;
            filter: blur(2px);
            pointer-events: none;
        }

        @keyframes node-pulse {
            0%, 100% { border-color: #4a6a7a; box-shadow: 0 0 5px rgba(90, 122, 138, 0.2); }
            50% { border-color: #8fa; box-shadow: 0 0 15px rgba(136, 255, 170, 0.3); }
        }

        /* Branch split visuals */

        .branch-group {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }

        /* Module Details Panel */

        .module-details {
            background: rgba(10, 25, 35, 0.9);
            border: 2px solid #3a4a5a;
            border-radius: 12px;
            padding: 20px;
            min-height: 130px;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
            border-left: 6px solid #5a7a8a;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5), 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .details-header {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .details-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.25rem;
            font-weight: 900;
            color: #fff;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .details-tier {
            font-size: 0.7rem;
            color: var(--p-color, #5a7a8a);
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            opacity: 0.8;
        }

        .details-desc {
            font-size: 1.4rem;
            color: #fff;
            line-height: 1.2;
            font-weight: 900;
            margin-top: 10px;
            text-shadow: 0 0 10px rgba(var(--p-rgb), 0.5);
            font-family: 'Orbitron', sans-serif;
        }

        .details-warning {
            color: #ff6b6b;
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-top: 8px;
            font-weight: 700;
            display: none;
            letter-spacing: 1px;
            padding: 4px 10px;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 4px;
            border-left: 3px solid #ff6b6b;
        }

        .upgrade-footer {
            margin-top: 20px;
            text-align: center;
            z-index: 10;
        }

        #installBtn {
            width: 100%;
            max-width: 300px;
            opacity: 0.4;
            pointer-events: none;
        }

        #installBtn.active {
            opacity: 1;
            pointer-events: auto;
            animation: install-pulse 2s infinite;
        }

        @keyframes install-pulse {
            0%, 100% { box-shadow: 0 4px 0 #1a2a1a, 0 0 10px rgba(100, 200, 100, 0.2); }
            50% { box-shadow: 0 4px 0 #1a2a1a, 0 0 25px rgba(100, 255, 100, 0.5); }
        }

        /* ============= PAUSE SCREEN ============= */

        #pauseScreen {
            background: rgba(0, 0, 0, 0.6);
        }

        #pauseScreen .content {
            background: linear-gradient(180deg, #1a2a30 0%, #0d1a20 100%);
            border: 4px solid #3a5a5a;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            padding: 40px;
        }

        .pause-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2rem;
            color: #b4d4c4;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .pause-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* ============= GAME OVER SCREEN ============= */

        #gameOverScreen .game-over-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 2.2rem;
            font-weight: 900;
            color: #ff6a6a;
            margin-bottom: 25px;
            text-transform: uppercase;
            letter-spacing: 3px;
            text-shadow: 0 0 20px rgba(255, 100, 100, 0.3);
        }

        .final-stats {
            background: linear-gradient(180deg, #1a2530 0%, #0d1520 100%);
            border: 3px solid #4a5a6a;
            border-radius: 12px;
            padding: 25px 35px;
            margin-bottom: 25px;
            box-shadow: inset 0 0 20px rgba(0, 20, 40, 0.5);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #2a3a4a;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6a8a9a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.4rem;
            font-weight: 900;
            color: #b4d4c4;
            font-family: 'Orbitron', monospace;
        }

        .upgrade-summary {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #2a3a4a;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.6rem;
            color: #5a6a7a;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #8ada8a;
            font-family: 'Orbitron', monospace;
        }

        .game-over-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* ============= SETTINGS MODAL ============= */

        #settingsModal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #1a2530 0%, #0d1520 100%);
            border: 4px solid #3a5a5a;
            border-radius: 16px;
            padding: 30px 40px;
            z-index: 100;
            box-shadow: 0 10px 50px rgba(0,0,0,0.6);
            min-width: 280px;
        }

        #settingsModal.hidden {
            display: none;
        }

        .settings-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5rem;
            color: #b4d4c4;
            margin-bottom: 25px;
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #2a3a4a;
        }

        .settings-row:last-of-type {
            border-bottom: none;
        }

        .settings-label {
            font-size: 1rem;
            color: #8a9aaa;
        }

        .toggle {
            width: 50px;
            height: 28px;
            background: #1a2a3a;
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            border: 2px solid #3a4a5a;
        }

        .toggle.active {
            background: #3a6a4a;
            border-color: #5a8a6a;
        }

        .toggle::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: #6a7a8a;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s ease;
        }

        .toggle.active::after {
            transform: translateX(22px);
            background: #8ada8a;
        }

        .settings-close {
            margin-top: 25px;
            width: 100%;
        }

        /* ============= RESPONSIVE ============= */

        @media (max-width: 400px) {
            .upgrade-card {
                width: 100px;
                padding: 14px 8px;
            }
            .upgrade-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            #startScreen .title {
                font-size: 1.8rem;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const a of n.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=t(s);fetch(s.href,n)}})();const r={CANNON_WHEEL_RADIUS:24,CANNON_BODY_WIDTH:80,CANNON_BODY_HEIGHT:28,CANNON_BARREL_LENGTH:50,CANNON_BARREL_WIDTH:18,CANNON_MAX_SPEED:1200,CANNON_ACCELERATION:3500,CANNON_FRICTION:8,BULLET_SPEED:14,BULLET_RADIUS:5,BULLET_POOL_SIZE:100,BASE_FIRE_INTERVAL:350,BOULDER_POOL_SIZE:50,BOULDER_SIZES:{large:{radius:75,health:1,points:30},medium:{radius:50,health:1,points:15},small:{radius:30,health:1,points:5}},BOULDER_GRAVITY:.12,BOULDER_BOUNCE:.82,BOULDER_SPAWN_INTERVAL_START:2800,BOULDER_SPAWN_INTERVAL_MIN:1e3,BOULDER_HEALTH_INCREASE_INTERVAL:36,PARTICLE_POOL_SIZE:300,UPGRADE_BASE_COUNT:12,BULLET_COLOR:"#ffd54f"};function x(){const u=window.__OASIZ_SETTINGS__;return{music:u?.music!==!1,fx:u?.fx!==!1,haptics:u?.haptics!==!1}}function w(u,e,t){return Math.max(e,Math.min(t,u))}function v(u,e){return u+Math.random()*(e-u)}function C(u,e,t,i){return Math.sqrt((t-u)**2+(i-e)**2)}function P(u){return 1+2.70158*Math.pow(u-1,3)+1.70158*Math.pow(u-1,2)}class M{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t)}emit(e,t){const i=this.listeners.get(e);i&&i.forEach(s=>s(t))}}class L{pool=[];createFn;resetFn;constructor(e,t,i=0){this.createFn=e,this.resetFn=t;for(let s=0;s<i;s++)this.pool.push(e())}acquire(){return this.pool.length>0?this.pool.pop():this.createFn()}release(e){this.resetFn(e),this.pool.push(e)}}class U{ctx=null;masterGain=null;sfxGain=null;musicGain=null;music=null;musicSource=null;initialized=!1;settings;constructor(e){this.settings=e,console.log("[AudioManager] Created")}init(){if(!this.initialized)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.masterGain=this.ctx.createGain(),this.masterGain.gain.value=.5,this.masterGain.connect(this.ctx.destination),this.sfxGain=this.ctx.createGain(),this.sfxGain.gain.value=.6,this.sfxGain.connect(this.masterGain),this.musicGain=this.ctx.createGain(),this.musicGain.gain.value=.4,this.musicGain.connect(this.masterGain),this.music=new Audio("https://oasiz-assets.vercel.app/audio/tank-song.mp3"),this.music.loop=!0,this.music.crossOrigin="anonymous",this.musicSource=this.ctx.createMediaElementSource(this.music),this.musicSource.connect(this.musicGain),this.initialized=!0,console.log("[AudioManager.init] Audio context and music initialized")}catch(e){console.warn("[AudioManager.init] Failed:",e)}}playMusic(){!this.music||!this.settings.music||!x().music||this.music.play().catch(e=>console.warn("[AudioManager.playMusic] Failed:",e))}stopMusic(){this.music&&(this.music.pause(),this.music.currentTime=0)}updateSettings(){this.music&&(this.settings.music||this.music.pause())}playShoot(){if(!this.ctx||!this.sfxGain||!this.settings.fx||!x().fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),i=this.ctx.createGain();t.type="square",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(150,e+.08),i.gain.setValueAtTime(.12,e),i.gain.exponentialRampToValueAtTime(.01,e+.08),t.connect(i),i.connect(this.sfxGain),t.start(e),t.stop(e+.1)}playHit(){if(!this.ctx||!this.sfxGain||!this.settings.fx||!x().fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),i=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(200,e),t.frequency.exponentialRampToValueAtTime(80,e+.1),i.gain.setValueAtTime(.1,e),i.gain.exponentialRampToValueAtTime(.01,e+.1),t.connect(i),i.connect(this.sfxGain),t.start(e),t.stop(e+.12)}playDestroy(e){if(!this.ctx||!this.sfxGain||!this.settings.fx||!x().fx)return;const t=this.ctx.currentTime,i=e==="large"?60:e==="medium"?100:180,s=this.ctx.sampleRate*.25,n=this.ctx.createBuffer(1,s,this.ctx.sampleRate),a=n.getChannelData(0);for(let d=0;d<s;d++)a[d]=(Math.random()*2-1)*Math.exp(-d/(this.ctx.sampleRate*.08));const o=this.ctx.createBufferSource();o.buffer=n;const l=this.ctx.createBiquadFilter();l.type="lowpass",l.frequency.value=i*6,l.Q.value=.7;const h=this.ctx.createGain();h.gain.setValueAtTime(.25,t),h.gain.exponentialRampToValueAtTime(.01,t+.2),o.connect(l),l.connect(h),h.connect(this.sfxGain),o.start(t)}playUpgrade(){if(!this.ctx||!this.sfxGain||!this.settings.fx||!x().fx)return;const e=this.ctx.currentTime;[392,523,659,784].forEach((i,s)=>{const n=this.ctx.createOscillator(),a=this.ctx.createGain();n.type="triangle",n.frequency.value=i,a.gain.setValueAtTime(.1,e+s*.1),a.gain.exponentialRampToValueAtTime(.01,e+s*.1+.2),n.connect(a),a.connect(this.sfxGain),n.start(e+s*.1),n.stop(e+s*.1+.25)})}playGameOver(){if(!this.ctx||!this.sfxGain||!this.settings.fx||!x().fx)return;const e=this.ctx.currentTime,t=this.ctx.createOscillator(),i=this.ctx.createGain();t.type="sawtooth",t.frequency.setValueAtTime(250,e),t.frequency.exponentialRampToValueAtTime(60,e+.6),i.gain.setValueAtTime(.15,e),i.gain.linearRampToValueAtTime(.1,e+.3),i.gain.exponentialRampToValueAtTime(.01,e+.6);const s=this.ctx.createBiquadFilter();s.type="lowpass",s.frequency.setValueAtTime(800,e),s.frequency.exponentialRampToValueAtTime(150,e+.5),t.connect(s),s.connect(i),i.connect(this.sfxGain),t.start(e),t.stop(e+.7)}triggerHaptic(e){!this.settings.haptics||!x().haptics||typeof window.triggerHaptic=="function"&&window.triggerHaptic(e)}}class O{particles=[];pool;constructor(){this.pool=new L(()=>({x:0,y:0,vx:0,vy:0,life:0,maxLife:1,size:4,color:"#fff",type:"spark",rotation:0,rotationSpeed:0}),e=>{e.life=0},r.PARTICLE_POOL_SIZE)}emit(e,t,i,s,n="spark"){for(let a=0;a<s;a++){const o=this.pool.acquire(),l=Math.random()*Math.PI*2,h=n==="explosion"?4+Math.random()*6:2+Math.random()*4;o.x=e,o.y=t,o.vx=Math.cos(l)*h,o.vy=Math.sin(l)*h,o.life=1,o.maxLife=1,o.size=n==="debris"?6+Math.random()*10:n==="explosion"?5+Math.random()*7:3+Math.random()*4,o.color=i,o.type=n,o.rotation=Math.random()*Math.PI*2,o.rotationSpeed=(Math.random()-.5)*.4,this.particles.push(o)}}update(e){for(let t=this.particles.length-1;t>=0;t--){const i=this.particles[t];i.x+=i.vx*e*60,i.y+=i.vy*e*60,i.vy+=.15*e*60,i.rotation+=i.rotationSpeed*e*60,i.life-=(i.type==="debris"?.018:.03)*e*60,i.life<=0&&(this.pool.release(i),this.particles.splice(t,1))}}draw(e){for(const t of this.particles){if(e.save(),e.globalAlpha=t.life*.9,e.translate(t.x,t.y),e.rotate(t.rotation),t.type==="debris"){e.fillStyle=t.color,e.beginPath();const i=t.size*t.life;e.moveTo(-i/2,-i/3),e.lineTo(i/2,-i/4),e.lineTo(i/3,i/3),e.lineTo(-i/3,i/2),e.closePath(),e.fill()}else e.fillStyle=t.color,e.beginPath(),e.arc(0,0,t.size*t.life,0,Math.PI*2),e.fill();e.restore()}}clear(){for(const e of this.particles)this.pool.release(e);this.particles=[]}}class _{texts=[];add(e,t,i,s="#fff",n=20){this.texts.push({x:e,y:t,text:i,life:1,color:s,size:n})}update(e){for(let t=this.texts.length-1;t>=0;t--){const i=this.texts[t];i.y-=50*e,i.life-=.025*e*60,i.life<=0&&this.texts.splice(t,1)}}draw(e){for(const t of this.texts)e.save(),e.globalAlpha=t.life,e.font="900 "+t.size*P(Math.min(1,(1-t.life)*3+.3))+"px Orbitron, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="rgba(0,0,0,0.4)",e.fillText(t.text,t.x+2,t.y+2),e.fillStyle=t.color,e.fillText(t.text,t.x,t.y),e.restore()}clear(){this.texts=[]}}const y=[{id:"f1",name:"Quick Fire",desc:"+25% fire rate",requires:null,tree:"fire",tier:1,sibling:null},{id:"f2a",name:"Rapid Fire",desc:"+50% fire rate",requires:"f1",tree:"fire",tier:2,sibling:"f2b"},{id:"f2b",name:"Heavy Rounds",desc:"2 damage per bullet",requires:"f1",tree:"fire",tier:2,sibling:"f2a"},{id:"f3a",name:"Gatling",desc:"+80% fire rate",requires:"f2a",tree:"fire",tier:3,sibling:null},{id:"f3b",name:"Armor Piercing",desc:"3 damage per bullet",requires:"f2b",tree:"fire",tier:3,sibling:null},{id:"f4a",name:"Bullet Storm",desc:"+100% fire rate",requires:"f3a",tree:"fire",tier:4,sibling:null},{id:"f4b",name:"Explosive Rounds",desc:"Explosions on hit",requires:"f3b",tree:"fire",tier:4,sibling:null},{id:"u1",name:"Double Barrel",desc:"Fire 2 bullets",requires:null,tree:"utility",tier:1,sibling:null},{id:"u2a",name:"Spread Shot",desc:"Fire 3 bullets, wide",requires:"u1",tree:"utility",tier:2,sibling:"u2b"},{id:"u2b",name:"Pierce Shot",desc:"Pierce 1 boulder",requires:"u1",tree:"utility",tier:2,sibling:"u2a"},{id:"u3a",name:"Barrage",desc:"Fire 5 bullets",requires:"u2a",tree:"utility",tier:3,sibling:null},{id:"u3b",name:"Full Pierce",desc:"Pierce all boulders",requires:"u2b",tree:"utility",tier:3,sibling:null},{id:"u4a",name:"Wall of Lead",desc:"Fire 8 bullets, 60deg",requires:"u3a",tree:"utility",tier:4,sibling:null},{id:"u4b",name:"Rail Gun",desc:"Pierce all, 5 damage",requires:"u3b",tree:"utility",tier:4,sibling:null},{id:"d1",name:"Reinforced Hull",desc:"Survive 1 hit",requires:null,tree:"defense",tier:1,sibling:null},{id:"d2a",name:"Shield Regen",desc:"Recharge after 10s",requires:"d1",tree:"defense",tier:2,sibling:"d2b"},{id:"d2b",name:"Kill Repair",desc:"5 kills restore shield",requires:"d1",tree:"defense",tier:2,sibling:"d2a"},{id:"d3a",name:"Energy Shield",desc:"Absorb 2 hits",requires:"d2a",tree:"defense",tier:3,sibling:null},{id:"d3b",name:"Fast Repair",desc:"3 kills restore",requires:"d2b",tree:"defense",tier:3,sibling:null},{id:"d4a",name:"Fortress",desc:"Absorb 3 hits",requires:"d3a",tree:"defense",tier:4,sibling:null},{id:"d4b",name:"Phoenix",desc:"Revive once per game",requires:"d3b",tree:"defense",tier:4,sibling:null}];function I(u){return y.find(e=>e.id===u)}class H{canvas;ctx;gameContainer;eventBus;particles;floatingText;audio;cannonX=0;cannonVx=0;wheelRotation=0;bulletPool;boulderPool;bullets=[];boulders=[];gameState="START";score=0;totalDestroyed=0;destroyedSinceUpgrade=0;upgradesEarned=0;fireTimer=0;spawnTimer=0;ownedUpgrades=new Set;lockedBranches=new Set;upgradePoints=0;shieldHits=0;maxShieldHits=0;shieldRechargeTimer=0;killsSinceShieldLost=0;invincibilityTimer=0;hasRevived=!1;w=0;h=0;isMobile=!1;groundY=0;screenShake={x:0,y:0,intensity:0};keysDown=new Set;touchCurrentX=null;isDragging=!1;isFiring=!1;settings;lastTime=0;boulderIdCounter=0;hasSelectedUpgrade=!1;selectedNodeId=null;demoCanvas=null;demoCtx=null;demoCannonX=0;demoCannonDir=1;demoBullets=[];demoBoulders=[];demoParticles=[];demoFireTimer=0;demoSpawnTimer=0;mountains=[];distantBase=[];stars=[];shootingStars=[];nebulae=[];lastShootingStarTime=0;constructor(){console.log("[CannonBlasterGame] Initializing"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.gameContainer=document.getElementById("game-container"),this.eventBus=new M,this.particles=new O,this.floatingText=new _,this.settings={music:localStorage.getItem("cannonBlaster_music")!=="false",fx:localStorage.getItem("cannonBlaster_fx")!=="false",haptics:localStorage.getItem("cannonBlaster_haptics")!=="false"},this.audio=new U(this.settings),this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.initEnvironment(),this.demoCanvas=document.getElementById("demoCanvas"),this.demoCanvas&&(this.demoCtx=this.demoCanvas.getContext("2d"),this.initDemoAnimation()),this.bulletPool=new L(()=>({x:0,y:0,vx:0,vy:0,damage:1,pierceRemaining:0,explosive:!1,active:!1}),e=>{e.active=!1},r.BULLET_POOL_SIZE),this.boulderPool=new L(()=>({id:0,size:"medium",health:1,maxHealth:1,x:0,y:0,vx:0,vy:0,rotation:0,rotationSpeed:0,active:!1,hitFlash:0,hasHitGround:!1}),e=>{e.active=!1,e.hasHitGround=!1},r.BOULDER_POOL_SIZE),this.setupEventListeners(),this.setupGameEvents(),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),requestAnimationFrame(e=>this.gameLoop(e))}setupEventListeners(){window.addEventListener("keydown",e=>{this.keysDown.add(e.key),e.key==="Escape"&&this.gameState==="PLAYING"?this.pauseGame():e.key==="Escape"&&this.gameState==="PAUSED"&&this.resumeGame()}),window.addEventListener("keyup",e=>{this.keysDown.delete(e.key)}),this.canvas.addEventListener("touchstart",e=>{e.preventDefault(),this.gameState==="PLAYING"&&(this.isDragging=!0,this.touchCurrentX=this.getRelativeX(e.touches[0].clientX))}),window.addEventListener("touchmove",e=>{this.isDragging&&this.gameState==="PLAYING"&&(this.touchCurrentX=this.getRelativeX(e.touches[0].clientX))},{passive:!1}),window.addEventListener("touchend",()=>{this.isDragging=!1,this.touchCurrentX=null}),this.canvas.addEventListener("mousedown",e=>{this.gameState==="PLAYING"&&!this.isMobile&&(this.isDragging=!0,this.touchCurrentX=this.getRelativeX(e.clientX))}),window.addEventListener("mousemove",e=>{this.isDragging&&this.gameState==="PLAYING"&&!this.isMobile&&(this.touchCurrentX=this.getRelativeX(e.clientX))}),window.addEventListener("mouseup",()=>{this.isDragging=!1,this.touchCurrentX=null}),document.getElementById("startButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("restartButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("menuButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("pauseBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.pauseGame()}),document.getElementById("resumeButton")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.resumeGame()}),document.getElementById("pauseRestartBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.startGame()}),document.getElementById("pauseMenuBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),this.showStartScreen()}),document.getElementById("settingsBtn")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.remove("hidden")}),document.getElementById("settingsClose")?.addEventListener("click",()=>{this.audio.triggerHaptic("light"),document.getElementById("settingsModal")?.classList.add("hidden")}),this.setupSettingToggle("musicToggle","music"),this.setupSettingToggle("fxToggle","fx"),this.setupSettingToggle("hapticToggle","haptics"),document.getElementById("installBtn")?.addEventListener("click",()=>{this.hasSelectedUpgrade?(this.audio.triggerHaptic("light"),this.continueFromUpgrade()):this.selectedNodeId&&this.installUpgrade()})}setupSettingToggle(e,t){const i=document.getElementById(e);i&&(i.classList.toggle("active",this.settings[t]),i.addEventListener("click",()=>{this.settings[t]=!this.settings[t],i.classList.toggle("active",this.settings[t]),localStorage.setItem("cannonBlaster_"+t,this.settings[t].toString()),this.audio.triggerHaptic("light"),t==="music"&&(this.settings.music&&this.gameState==="PLAYING"?this.audio.playMusic():this.settings.music||this.audio.stopMusic())}))}setupGameEvents(){this.eventBus.on("BOULDER_DESTROYED",e=>{const{boulder:t,points:i}=e;console.log("[Event] BOULDER_DESTROYED",t.size,"points:",i);let s=i,n=!1;t.size!=="large"&&!t.hasHitGround&&(n=!0,s+=Math.ceil(i*.5)),this.score+=s,this.totalDestroyed++,this.destroyedSinceUpgrade++,this.audio.playDestroy(t.size),this.audio.triggerHaptic(n?"success":t.size==="large"?"heavy":"medium"),this.particles.emit(t.x,t.y,"#8a7a6a",10,"debris"),this.particles.emit(t.x,t.y,"#ffa500",6,"explosion"),this.floatingText.add(t.x,t.y,"+"+s,n?"#44ff88":"#ffd54f",n?28:22),n&&this.floatingText.add(t.x,t.y-30,"AIRBORNE BONUS!","#44ff88",14);const a=t.size==="large"?.6:t.size==="medium"?.35:.15;if(this.triggerScreenShake(a),this.shieldHits<this.maxShieldHits){this.killsSinceShieldLost++;let l=99999;this.ownedUpgrades.has("d4c")?l=5:this.ownedUpgrades.has("d3c")?l=8:this.ownedUpgrades.has("d2b")&&(l=5),this.killsSinceShieldLost>=l&&(this.shieldHits=this.maxShieldHits,this.killsSinceShieldLost=0,this.floatingText.add(this.cannonX,this.groundY-100,"SHIELD RESTORED","#44ff88",18),this.audio.triggerHaptic("success"))}this.updateProgressBar();const o=this.getDestructionsNeededForNextUpgrade();this.destroyedSinceUpgrade>=o&&(console.log("[Game] Triggering upgrade after",this.destroyedSinceUpgrade,"destructions (needed "+o+")"),this.showUpgradeScreen())}),this.eventBus.on("BOULDER_HIT",e=>{const{boulder:t}=e;this.audio.playHit(),this.audio.triggerHaptic("light"),t.hitFlash=.15,this.particles.emit(t.x,t.y,"#ffcc00",3,"spark")}),this.eventBus.on("PLAYER_HIT",()=>{if(console.log("[Event] PLAYER_HIT"),this.invincibilityTimer>0){console.log("[Event] Player invincible, ignoring hit");return}if(this.shieldHits>0){this.shieldHits--,this.invincibilityTimer=1e3,console.log("[Event] Shield absorbed hit, remaining:",this.shieldHits),this.audio.triggerHaptic("medium"),this.triggerScreenShake(.4),this.floatingText.add(this.cannonX,this.groundY-80,"SHIELD HIT","#ffaa00",16),this.shieldHits===0&&this.ownedUpgrades.has("d3d")&&(this.invincibilityTimer=2e3,this.floatingText.add(this.cannonX,this.groundY-100,"SECOND WIND!","#44ff88",20));return}if(!this.hasRevived&&this.ownedUpgrades.has("d4d")){this.hasRevived=!0,this.shieldHits=this.maxShieldHits,this.invincibilityTimer=3e3,this.floatingText.add(this.cannonX,this.groundY-100,"PHOENIX PROTOCOL!","#ff4444",24),this.audio.triggerHaptic("success"),this.triggerScreenShake(.8);return}console.log("[Event] No defenses remaining - Game Over"),this.gameOver()})}resizeCanvas(){this.w=this.gameContainer.clientWidth,this.h=this.gameContainer.clientHeight,this.canvas.width=this.w,this.canvas.height=this.h,this.groundY=this.h-50,console.log("[resizeCanvas]",this.w,"x",this.h)}getRelativeX(e){const t=this.gameContainer.getBoundingClientRect();return e-t.left}resetCannon(){console.log("[resetCannon] Resetting cannon position"),this.cannonX=this.w/2,this.cannonVx=0,this.wheelRotation=0}startGame(){console.log("[startGame] Starting game"),this.audio.init(),this.audio.playMusic(),this.gameState="PLAYING",this.score=0,this.totalDestroyed=0,this.destroyedSinceUpgrade=0,this.upgradesEarned=0,this.fireTimer=0,this.spawnTimer=0,this.ownedUpgrades=new Set,this.lockedBranches=new Set,this.upgradePoints=0,this.hasSelectedUpgrade=!1,this.selectedNodeId=null,this.shieldHits=0,this.maxShieldHits=0,this.shieldRechargeTimer=0,this.killsSinceShieldLost=0,this.invincibilityTimer=0,this.hasRevived=!1;for(const e of this.bullets)this.bulletPool.release(e);this.bullets=[];for(const e of this.boulders)this.boulderPool.release(e);this.boulders=[],this.particles.clear(),this.floatingText.clear(),this.resetCannon(),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.remove("hidden"),document.getElementById("pauseBtn")?.classList.remove("hidden"),this.updateHUD(),this.updateProgressBar(),this.updateUpgradeDots()}showStartScreen(){console.log("[showStartScreen]"),this.gameState="START",document.getElementById("startScreen")?.classList.remove("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("pauseScreen")?.classList.add("hidden"),document.getElementById("upgradeScreen")?.classList.add("hidden"),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),this.initDemoAnimation()}pauseGame(){this.gameState==="PLAYING"&&(console.log("[pauseGame]"),this.gameState="PAUSED",document.getElementById("pauseScreen")?.classList.remove("hidden"))}resumeGame(){this.gameState==="PAUSED"&&(console.log("[resumeGame]"),this.gameState="PLAYING",document.getElementById("pauseScreen")?.classList.add("hidden"))}gameOver(){console.log("[gameOver] Score:",this.score,"Destroyed:",this.totalDestroyed),this.gameState="GAME_OVER",this.audio.stopMusic(),this.audio.playGameOver(),this.audio.triggerHaptic("error"),typeof window.submitScore=="function"&&(window.submitScore(this.score),console.log("[gameOver] Score submitted:",this.score)),document.getElementById("finalScore").textContent=this.score.toString(),document.getElementById("finalDestroyed").textContent=this.totalDestroyed.toString();const e=y.filter(s=>s.tree==="fire"&&this.ownedUpgrades.has(s.id)).length,t=y.filter(s=>s.tree==="utility"&&this.ownedUpgrades.has(s.id)).length,i=y.filter(s=>s.tree==="defense"&&this.ownedUpgrades.has(s.id)).length;document.getElementById("summaryRate").textContent=e.toString(),document.getElementById("summaryPower").textContent=t.toString(),document.getElementById("summaryMulti").textContent=i.toString(),document.getElementById("hud")?.classList.add("hidden"),document.getElementById("pauseBtn")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.remove("hidden")}showUpgradeScreen(){console.log("[showUpgradeScreen]"),this.gameState="UPGRADE",this.hasSelectedUpgrade=!1,this.selectedNodeId=null,this.upgradePoints=1,this.updateDetailsPanel(null),this.renderSchematic(),document.getElementById("upgradeScreen")?.classList.remove("hidden")}renderSchematic(){const e={fire:document.getElementById("pillarFire"),utility:document.getElementById("pillarUtility"),defense:document.getElementById("pillarDefense")};Object.values(e).forEach(s=>{s&&(s.innerHTML="")});const t={fire:{},utility:{},defense:{}};y.forEach(s=>{t[s.tree][s.tier]||(t[s.tree][s.tier]=[]),t[s.tree][s.tier].push(s)}),["fire","utility","defense"].forEach(s=>{const n=e[s];if(!n)return;Object.keys(t[s]).map(Number).sort((o,l)=>o-l).forEach(o=>{const l=t[s][o],h=document.createElement("div");h.className="branch-group",l.forEach(d=>{const g=document.createElement("div");g.className="node",g.setAttribute("data-id",d.id);const f=document.createElement("div");f.className="node-icon",f.textContent=d.tree[0].toUpperCase(),g.appendChild(f);const S=this.ownedUpgrades.has(d.id),E=this.lockedBranches.has(d.id),c=this.canPurchase(d.id),p=this.selectedNodeId===d.id;let m=!0;(S||E||c||d.requires===null||this.ownedUpgrades.has(d.requires))&&(m=!1),S?g.classList.add("owned"):p?g.classList.add("selected"):c?g.classList.add("available"):E?g.classList.add("locked-branch"):m&&g.classList.add("fog"),g.addEventListener("click",()=>{m||E||S||this.previewUpgrade(d.id)}),h.appendChild(g)}),n.appendChild(h)})});const i=document.getElementById("installBtn");i&&(this.selectedNodeId&&!this.hasSelectedUpgrade?i.classList.add("active"):i.classList.remove("active"))}previewUpgrade(e){console.log("[previewUpgrade]",e),this.selectedNodeId=e,this.audio.triggerHaptic("light");const t=I(e);this.updateDetailsPanel(t||null),this.renderSchematic()}updateDetailsPanel(e){const t=document.getElementById("detailsName"),i=document.getElementById("detailsTier"),s=document.getElementById("detailsDesc"),n=document.getElementById("detailsWarning"),a=document.getElementById("moduleDetails");if(!e){t&&(t.textContent="SELECT MODULE"),i&&(i.textContent="SYSTEM READY"),s&&(s.textContent="Select an available module to view technical specifications."),n&&(n.style.display="none"),a&&(a.style.borderLeftColor="#5a7a8a",a.style.removeProperty("--p-color"));return}const o={fire:"#ffaa00",utility:"#00ccff",defense:"#44ff88"};if(a&&(a.style.borderLeftColor=o[e.tree],a.style.setProperty("--p-color",o[e.tree])),t&&(t.textContent=e.name),i&&(i.textContent="CLASS "+e.tier+" "+e.tree.toUpperCase()+" SYSTEM"),s&&(s.textContent=e.desc),n)if(e.sibling){const l=I(e.sibling);n.textContent="LOCKOUT WARNING: Installing this will offline "+(l?.name||"alternate branch")+".",n.style.display="block"}else n.style.display="none"}installUpgrade(){if(!this.selectedNodeId||this.hasSelectedUpgrade)return;const e=this.selectedNodeId,t=I(e);if(!t)return;console.log("[installUpgrade]",e),this.ownedUpgrades.add(e),this.upgradePoints--,this.hasSelectedUpgrade=!0,this.upgradesEarned++,t.sibling&&(this.lockedBranches.add(t.sibling),this.lockDownstream(t.sibling)),this.audio.playUpgrade(),this.audio.triggerHaptic("success"),this.applyUpgradeEffects(e),this.renderSchematic(),this.updateUpgradeDots();const i=document.getElementById("installBtn");i&&(i.textContent="Upgrade Installed - Continue",i.classList.add("active"))}canPurchase(e){const t=I(e);return!t||this.upgradePoints<=0||this.ownedUpgrades.has(e)||this.lockedBranches.has(e)?!1:t.requires===null?!0:this.ownedUpgrades.has(t.requires)}lockDownstream(e){y.forEach(t=>{t.requires===e&&!this.lockedBranches.has(t.id)&&(this.lockedBranches.add(t.id),this.lockDownstream(t.id))})}continueFromUpgrade(){if(!this.hasSelectedUpgrade)return;this.gameState="PLAYING",this.destroyedSinceUpgrade=0;const e=document.getElementById("installBtn");e&&(e.textContent="Initiate Install"),document.getElementById("upgradeScreen")?.classList.add("hidden"),this.updateProgressBar()}applyUpgradeEffects(e){console.log("[applyUpgradeEffects]",e),e==="d1"?(this.maxShieldHits=1,this.shieldHits=1):e==="d3a"?(this.maxShieldHits=2,this.shieldHits=2):e==="d4a"&&(this.maxShieldHits=3,this.shieldHits=3)}getDestructionsNeededForNextUpgrade(){const e=this.upgradesEarned;return e<=1?r.UPGRADE_BASE_COUNT:e===2?14:e===3?16:16+(e-3)*4}getDifficultyMultiplier(){return this.upgradesEarned===0?1:1.25*Math.pow(1.15,this.upgradesEarned-1)}updateHUD(){document.getElementById("scoreDisplay").textContent=this.score.toString(),document.getElementById("destroyedDisplay").textContent=this.totalDestroyed.toString()}updateProgressBar(){const e=this.getDestructionsNeededForNextUpgrade(),t=Math.min(this.destroyedSinceUpgrade/e,1),i=document.getElementById("progressFill");i&&(i.style.width=t*100+"%");const s=document.getElementById("progressText");s&&(s.textContent=this.destroyedSinceUpgrade+"/"+e)}updateUpgradeDots(){["fire","utility","defense"].forEach(t=>{const i=document.getElementById(t+"DotsRow");if(!i)return;const s=y.filter(a=>a.tree===t&&this.ownedUpgrades.has(a.id)).length,n=y.filter(a=>a.tree===t).length;i.innerHTML="";for(let a=0;a<Math.min(n,11);a++){const o=document.createElement("div");o.className="dot"+(a<s?" filled":""),i.appendChild(o)}})}triggerScreenShake(e){this.screenShake.intensity=Math.max(this.screenShake.intensity,e)}updateCannon(e){const t=this.keysDown.has("ArrowLeft")||this.keysDown.has("a")||this.keysDown.has("A"),i=this.keysDown.has("ArrowRight")||this.keysDown.has("d")||this.keysDown.has("D");if(this.isFiring=t||i||this.isDragging,this.isDragging&&this.touchCurrentX!==null){const n=this.touchCurrentX-this.cannonX;this.cannonVx=n*22,this.cannonVx=w(this.cannonVx,-1200,r.CANNON_MAX_SPEED),Math.abs(n)<2&&(this.cannonVx=0,this.cannonX=this.touchCurrentX)}else{let n=0;t?n=-1:i&&(n=1),n!==0?(this.cannonVx+=n*r.CANNON_ACCELERATION*e,this.cannonVx=w(this.cannonVx,-1200,r.CANNON_MAX_SPEED)):(this.cannonVx*=Math.pow(.001,e*r.CANNON_FRICTION),Math.abs(this.cannonVx)<1&&(this.cannonVx=0))}this.cannonX+=this.cannonVx*e;const s=r.CANNON_BODY_WIDTH/2+r.CANNON_WHEEL_RADIUS;this.cannonX=w(this.cannonX,s,this.w-s),(this.cannonX<=s||this.cannonX>=this.w-s)&&(this.cannonVx=0),this.wheelRotation+=this.cannonVx*e/r.CANNON_WHEEL_RADIUS}getFireRateMultiplier(){let e=1;return this.ownedUpgrades.has("f1")&&(e-=.25),this.ownedUpgrades.has("f2a")&&(e-=.25),this.ownedUpgrades.has("f3a")&&(e-=.3),this.ownedUpgrades.has("f4a")&&(e-=.2),Math.max(.2,e)}fireBullets(){let e=1,t=0;this.ownedUpgrades.has("u1")&&(e=2,t=8),this.ownedUpgrades.has("u2a")&&(e=3,t=15),this.ownedUpgrades.has("u3a")&&(e=4,t=20),this.ownedUpgrades.has("u3b")&&(t=30),this.ownedUpgrades.has("u4a")&&(e=6,t=35),this.ownedUpgrades.has("u4b")&&(e=8,t=60);let i=1;this.ownedUpgrades.has("f2b")&&(i=2),this.ownedUpgrades.has("f3c")&&(i=3),this.ownedUpgrades.has("f4c")&&(i=5);let s=0;this.ownedUpgrades.has("u2b")&&(s=1),this.ownedUpgrades.has("u3c")&&(s=99);let n=!1;(this.ownedUpgrades.has("f3d")||this.ownedUpgrades.has("f4d"))&&(n=!0);const a=this.ownedUpgrades.has("f4b")?5:this.ownedUpgrades.has("f3b")?3:1,o=this.groundY-r.CANNON_WHEEL_RADIUS-r.CANNON_BODY_HEIGHT-r.CANNON_BARREL_LENGTH,l=-Math.PI/2,h=l-t/2*Math.PI/180,d=e>1?t*Math.PI/180/(e-1):0;for(let g=0;g<a;g++)for(let f=0;f<e;f++){const S=e===1?l:h+d*f,E=this.ownedUpgrades.has("f4a")?(Math.random()-.5)*.1:0,c=this.bulletPool.acquire();c.x=this.cannonX,c.y=o-g*5,c.vx=Math.cos(S+E)*r.BULLET_SPEED,c.vy=Math.sin(S+E)*r.BULLET_SPEED,c.damage=i,c.pierceRemaining=s,c.explosive=n,c.active=!0,this.bullets.push(c)}this.audio.playShoot(),this.audio.triggerHaptic("light")}updateShieldRecharge(e){this.shieldHits<this.maxShieldHits&&this.ownedUpgrades.has("d2a")&&(this.shieldRechargeTimer+=e*1e3,this.shieldRechargeTimer>=1e4&&(this.shieldHits=this.maxShieldHits,this.shieldRechargeTimer=0,this.floatingText.add(this.cannonX,this.groundY-100,"SHIELD RESTORED","#44ff88",18),this.audio.triggerHaptic("success"))),this.invincibilityTimer>0&&(this.invincibilityTimer-=e*1e3)}updateBullets(e){for(let t=this.bullets.length-1;t>=0;t--){const i=this.bullets[t];i.x+=i.vx*e*60,i.y+=i.vy*e*60,(i.y<-50||i.y>this.h+50||i.x<-50||i.x>this.w+50)&&(this.bulletPool.release(i),this.bullets.splice(t,1))}}spawnBoulder(e,t,i,s,n){if(!e){const d=Math.random(),g=w(.1+this.totalDestroyed/200,.1,.35);d<g?e="large":d<g+.4?e="medium":e="small"}const a=r.BOULDER_SIZES[e],o=this.boulderPool.acquire();let l=0;e!=="small"&&(l=Math.floor(this.totalDestroyed/r.BOULDER_HEALTH_INCREASE_INTERVAL),l=w(l,0,2)),o.id=++this.boulderIdCounter,o.size=e,o.maxHealth=a.health+l,o.health=o.maxHealth,o.x=t??v(a.radius+30,this.w-a.radius-30),o.y=i??-a.radius-20;const h=this.getDifficultyMultiplier();o.vx=s??v(-.8,.8)*h,o.vy=n??v(.8,2)*h,o.rotation=Math.random()*Math.PI*2,o.rotationSpeed=(Math.random()-.5)*.03,o.active=!0,o.hitFlash=0,o.hasHitGround=!1,this.boulders.push(o)}updateBoulders(e){for(let t=this.boulders.length-1;t>=0;t--){const i=this.boulders[t],s=r.BOULDER_SIZES[i.size];i.vy+=r.BOULDER_GRAVITY*e*60,i.x+=i.vx*e*60,i.y+=i.vy*e*60,i.rotation+=i.rotationSpeed*e*60,i.hitFlash>0&&(i.hitFlash-=e),i.x-s.radius<0?(i.x=s.radius,i.vx=Math.abs(i.vx)*r.BOULDER_BOUNCE):i.x+s.radius>this.w&&(i.x=this.w-s.radius,i.vx=-Math.abs(i.vx)*r.BOULDER_BOUNCE),i.y+s.radius>this.groundY&&(i.y=this.groundY-s.radius,i.vy=-Math.abs(i.vy)*r.BOULDER_BOUNCE,i.vx*=.95,i.hasHitGround=!0),i.y>this.h+100&&(this.boulderPool.release(i),this.boulders.splice(t,1))}}checkCollisions(){for(let i=this.bullets.length-1;i>=0;i--){const s=this.bullets[i];if(s.active)for(let n=this.boulders.length-1;n>=0;n--){const a=this.boulders[n];if(!a.active)continue;const o=r.BOULDER_SIZES[a.size];if(C(s.x,s.y,a.x,a.y)<o.radius+r.BULLET_RADIUS){if(a.health-=s.damage,this.eventBus.emit("BOULDER_HIT",{boulder:a}),a.health<=0){const h=o.points;this.eventBus.emit("BOULDER_DESTROYED",{boulder:a,points:h}),this.splitBoulder(a),s.explosive&&this.handleExplosion(a.x,a.y,2,60),this.boulderPool.release(a),this.boulders.splice(n,1)}if(s.pierceRemaining>0)s.pierceRemaining--;else{this.bulletPool.release(s),this.bullets.splice(i,1);break}}}}const e=this.groundY-r.CANNON_WHEEL_RADIUS-r.CANNON_BODY_HEIGHT/2;let t=r.CANNON_BODY_WIDTH/2;(this.shieldHits>0||this.invincibilityTimer>0)&&(t=r.CANNON_BODY_WIDTH*1.1);for(const i of this.boulders){const s=r.BOULDER_SIZES[i.size];if(C(i.x,i.y,this.cannonX,e)<s.radius+t-5){this.eventBus.emit("PLAYER_HIT",{});return}}}splitBoulder(e){if(e.size==="small")return;const t=e.size==="large"?"medium":"small";for(let i=0;i<2;i++){const s=i===0?-1:1,n=s*v(3,5),a=v(-5,-8);this.spawnBoulder(t,e.x+s*25,e.y-5,n,a)}}handleExplosion(e,t,i,s){this.particles.emit(e,t,"#ff6600",12,"explosion"),this.triggerScreenShake(.5);for(const n of this.boulders)if(C(e,t,n.x,n.y)<s&&(n.health-=i,n.health<=0)){const o=r.BOULDER_SIZES[n.size];this.eventBus.emit("BOULDER_DESTROYED",{boulder:n,points:o.points})}}initEnvironment(){this.stars=[];for(let i=0;i<120;i++)this.stars.push({x:Math.random()*1e3,y:Math.random()*1e3,s:.4+Math.random()*1.2,o:.1+Math.random()*.5});this.mountains=[];let e=-200;for(;e<1200;){const i=300+Math.random()*400,s=80+Math.random()*120;this.mountains.push({x:e,w:i,h:s}),e+=i*.5}this.distantBase=[];let t=0;for(;t<1e3;){const i=60+Math.random()*100,s=30+Math.random()*50;Math.random()>.6&&this.distantBase.push({x:t,w:i,h:s}),t+=i+50+Math.random()*150}this.nebulae=[{x:200,y:200,r:300,c:"rgba(68, 100, 255, 0.05)"},{x:800,y:400,r:400,c:"rgba(144, 255, 170, 0.03)"},{x:500,y:600,r:350,c:"rgba(255, 100, 200, 0.03)"}]}drawBackground(){const e=this.ctx,t=Date.now(),i=e.createLinearGradient(0,0,0,this.h);i.addColorStop(0,"#050a14"),i.addColorStop(.5,"#0a1525"),i.addColorStop(1,"#0d1a2d"),e.fillStyle=i,e.fillRect(0,0,this.w,this.h);for(const n of this.nebulae){const a=n.x/1e3*this.w+Math.sin(t/5e3+n.x)*20,o=n.y/1e3*this.h+Math.cos(t/4e3+n.y)*20,l=e.createRadialGradient(a,o,0,a,o,n.r);l.addColorStop(0,n.c),l.addColorStop(1,"rgba(0,0,0,0)"),e.fillStyle=l,e.fillRect(0,0,this.w,this.h)}e.fillStyle="#fff";for(const n of this.stars){const a=.7+Math.sin(t/1500+n.x*10)*.3;e.globalAlpha=n.o*a,e.beginPath(),e.arc(n.x/1e3*this.w,n.y/1e3*this.h*.8,n.s,0,Math.PI*2),e.fill()}e.globalAlpha=1,t-this.lastShootingStarTime>8e3+Math.random()*12e3&&(this.shootingStars.push({x:Math.random()*this.w,y:Math.random()*this.h*.4,vx:15+Math.random()*10,vy:5+Math.random()*5,life:1,len:40+Math.random()*60}),this.lastShootingStarTime=t),e.lineWidth=2;for(let n=this.shootingStars.length-1;n>=0;n--){const a=this.shootingStars[n],o=e.createLinearGradient(a.x,a.y,a.x-a.vx*2,a.y-a.vy*2);o.addColorStop(0,`rgba(255, 255, 255, ${a.life})`),o.addColorStop(1,"rgba(255, 255, 255, 0)"),e.strokeStyle=o,e.beginPath(),e.moveTo(a.x,a.y),e.lineTo(a.x-a.vx*(a.len/20),a.y-a.vy*(a.len/20)),e.stroke(),a.x+=a.vx,a.y+=a.vy,a.life-=.02,a.life<=0&&this.shootingStars.splice(n,1)}e.fillStyle="rgba(10, 20, 35, 0.6)";for(const n of this.mountains){const a=n.x/1e3*this.w,o=n.w/1e3*this.w,l=n.h/1e3*this.h;e.beginPath(),e.moveTo(a,this.groundY),e.lineTo(a+o/2,this.groundY-l),e.lineTo(a+o,this.groundY),e.fill()}e.fillStyle="rgba(20, 30, 50, 0.4)";for(const n of this.distantBase){const a=n.x/1e3*this.w,o=n.w/1e3*this.w,l=n.h/1e3*this.h;e.fillRect(a,this.groundY-l,o,l),l>30&&(e.fillStyle="rgba(255, 200, 100, 0.15)",e.fillRect(a+o*.2,this.groundY-l+10,o*.1,4),e.fillRect(a+o*.7,this.groundY-l+15,o*.1,4),e.fillStyle="rgba(20, 30, 50, 0.4)")}const s=e.createRadialGradient(this.w/2,this.h/2,this.w*.3,this.w/2,this.h/2,this.w*.9);s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(1,"rgba(5, 10, 20, 0.5)"),e.fillStyle=s,e.fillRect(0,0,this.w,this.h)}drawGround(){const e=this.ctx,t=e.createLinearGradient(0,this.groundY,0,this.groundY+50);t.addColorStop(0,"#2a3a30"),t.addColorStop(1,"#1a2520"),e.fillStyle=t,e.fillRect(0,this.groundY,this.w,50),e.strokeStyle="rgba(144, 255, 170, 0.1)",e.lineWidth=1;for(let i=0;i<this.w;i+=100)e.strokeRect(i+10,this.groundY+10,80,30),e.fillStyle="rgba(144, 255, 170, 0.2)",e.beginPath(),e.arc(i+20,this.groundY+20,2,0,Math.PI*2),e.arc(i+80,this.groundY+20,2,0,Math.PI*2),e.fill();e.strokeStyle="#4a8a60",e.lineWidth=3,e.beginPath(),e.moveTo(0,this.groundY),e.lineTo(this.w,this.groundY),e.stroke(),e.shadowBlur=15,e.shadowColor="#44ff88",e.strokeStyle="rgba(68, 255, 136, 0.3)",e.stroke(),e.shadowBlur=0}drawCannon(){const e=this.ctx,t=r.CANNON_WHEEL_RADIUS,i=r.CANNON_BODY_WIDTH,s=r.CANNON_BODY_HEIGHT,n=this.groundY-t,a=n-s/2-2,o=i/2+t*.2,l=[this.cannonX-o,this.cannonX+o];for(const c of l){e.save(),e.translate(c,n),e.rotate(this.wheelRotation),e.fillStyle="#111",e.beginPath(),e.arc(0,0,t,0,Math.PI*2),e.fill(),e.fillStyle="#333",e.beginPath(),e.arc(0,0,t*.65,0,Math.PI*2),e.fill(),e.strokeStyle="#444",e.lineWidth=4;for(let p=0;p<6;p++){const m=p/6*Math.PI*2;e.beginPath(),e.moveTo(0,0),e.lineTo(Math.cos(m)*t*.9,Math.sin(m)*t*.9),e.stroke()}e.strokeStyle="#555",e.lineWidth=2,e.beginPath(),e.arc(0,0,t*.65,0,Math.PI*2),e.stroke(),e.fillStyle="#666",e.beginPath(),e.arc(0,0,t*.15,0,Math.PI*2),e.fill(),e.restore()}e.save(),e.translate(this.cannonX,a),e.fillStyle="#222",e.beginPath(),e.roundRect(-i/2,-s/2,i,s,4),e.fill(),e.fillStyle="#2a2a2a",e.beginPath(),e.roundRect(-i/2+10,-s/2-5,i-20,10,3),e.fill(),e.fillStyle="#444";const h=i/2-10,d=s/2-8;[[-h,-d],[h,-d],[-h,d],[h,d]].forEach(([c,p])=>{e.beginPath(),e.arc(c,p,2.5,0,Math.PI*2),e.fill()}),e.strokeStyle="#333",e.lineWidth=2,e.beginPath(),e.roundRect(-i/2,-s/2,i,s,4),e.stroke(),e.restore();const g=a-s/2;e.save(),e.translate(this.cannonX,g);const f=e.createLinearGradient(-18/2,0,r.CANNON_BARREL_WIDTH/2,0);f.addColorStop(0,"#0a0a0a"),f.addColorStop(.4,"#2a2a2a"),f.addColorStop(.6,"#2a2a2a"),f.addColorStop(1,"#0a0a0a"),e.fillStyle=f,e.beginPath(),e.moveTo(-18/2,0),e.lineTo(-18/2-2,-50),e.lineTo(r.CANNON_BARREL_WIDTH/2+2,-50),e.lineTo(r.CANNON_BARREL_WIDTH/2,0),e.closePath(),e.fill(),e.fillStyle="#333";const S=4;if([-10,-50*.6].forEach(c=>{e.fillRect(-18/2-2,c,r.CANNON_BARREL_WIDTH+4,S)}),e.fillStyle="#1a1a1a",e.beginPath(),e.roundRect(-18/2-4,-50,r.CANNON_BARREL_WIDTH+8,8,2),e.fill(),e.fillStyle="#000",e.beginPath(),e.ellipse(0,-50,r.CANNON_BARREL_WIDTH/2+1,4,0,0,Math.PI*2),e.fill(),e.restore(),this.shieldHits>0||this.invincibilityTimer>0){e.save(),e.translate(this.cannonX,a);const c=r.CANNON_BODY_WIDTH*1.1,p=Math.sin(Date.now()/200)*.1+.9,m=this.invincibilityTimer>0,B=m?"rgba(255, 255, 255,":"rgba(68, 255, 136,",R=m?p*.5:p*.3;e.beginPath(),e.arc(0,0,c,0,Math.PI*2);const T=e.createRadialGradient(0,0,c*.7,0,0,c);if(T.addColorStop(0,B+"0)"),T.addColorStop(.8,B+R+")"),T.addColorStop(1,B+"0)"),e.strokeStyle=B+(R+.2)+")",e.lineWidth=2,e.fillStyle=T,e.fill(),e.stroke(),this.maxShieldHits>0)for(let b=0;b<this.maxShieldHits;b++){const A=-Math.PI/2+(b-(this.maxShieldHits-1)/2)*.3,N=Math.cos(A)*(c+8),D=Math.sin(A)*(c+8);e.fillStyle=b<this.shieldHits?"#44ff88":"#224422",e.beginPath(),e.arc(N,D,4,0,Math.PI*2),e.fill(),b<this.shieldHits&&(e.shadowBlur=10,e.shadowColor="#44ff88",e.stroke(),e.shadowBlur=0)}e.restore()}}drawBullets(){const e=this.ctx;for(const t of this.bullets){e.save(),e.translate(t.x,t.y);const i=e.createRadialGradient(0,0,0,0,0,r.BULLET_RADIUS*2);i.addColorStop(0,"rgba(255, 213, 79, 0.8)"),i.addColorStop(.5,"rgba(255, 180, 50, 0.3)"),i.addColorStop(1,"rgba(255, 150, 0, 0)"),e.fillStyle=i,e.beginPath(),e.arc(0,0,r.BULLET_RADIUS*2,0,Math.PI*2),e.fill(),e.fillStyle=r.BULLET_COLOR,e.beginPath(),e.arc(0,0,r.BULLET_RADIUS,0,Math.PI*2),e.fill(),e.restore()}}drawBoulders(){const e=this.ctx;for(const t of this.boulders){const i=r.BOULDER_SIZES[t.size];e.save(),e.translate(t.x,t.y),e.rotate(t.rotation),t.hitFlash>0&&(e.globalAlpha=.6+t.hitFlash*2);const s=e.createRadialGradient(-i.radius*.3,-i.radius*.3,0,0,0,i.radius);s.addColorStop(0,"#6a5a4a"),s.addColorStop(1,"#3a2a20"),e.fillStyle=s,e.beginPath();const n=8;for(let a=0;a<n;a++){const o=a/n*Math.PI*2,l=.85+Math.sin(t.id*73+a*41)*.2,h=i.radius*l;a===0?e.moveTo(Math.cos(o)*h,Math.sin(o)*h):e.lineTo(Math.cos(o)*h,Math.sin(o)*h)}e.closePath(),e.fill(),e.strokeStyle="#8a7a6a",e.lineWidth=3,e.stroke(),e.strokeStyle="#2a1a10",e.lineWidth=1.5;for(let a=0;a<3;a++){const o=(t.id*31+a*100)*(Math.PI/180),l=o+.6;e.beginPath(),e.moveTo(Math.cos(o)*i.radius*.2,Math.sin(o)*i.radius*.2),e.lineTo(Math.cos(l)*i.radius*.6,Math.sin(l)*i.radius*.6),e.stroke()}e.rotate(-t.rotation),e.font="900 "+i.radius*.7+"px Orbitron, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle="#000",e.fillText(t.health.toString(),2,2),e.fillStyle="#fff",e.fillText(t.health.toString(),0,0),e.restore()}}initDemoAnimation(){if(!this.demoCanvas)return;console.log("[initDemoAnimation]");const e=this.demoCanvas.parentElement;e&&(this.demoCanvas.width=e.clientWidth,this.demoCanvas.height=e.clientHeight),this.demoCannonX=this.demoCanvas.width/2,this.demoCannonDir=1,this.demoBullets=[],this.demoBoulders=[],this.demoParticles=[]}updateDemoAnimation(e){if(!this.demoCanvas||!this.demoCtx)return;const t=this.demoCanvas.width,i=this.demoCanvas.height;this.demoCannonX+=this.demoCannonDir*40*e,this.demoCannonX>t-40?this.demoCannonDir=-1:this.demoCannonX<40&&(this.demoCannonDir=1),this.demoFireTimer-=e*1e3,this.demoFireTimer<=0&&(this.demoBullets.push({x:this.demoCannonX,y:i-35,vy:-8}),this.demoFireTimer=250),this.demoSpawnTimer-=e*1e3,this.demoSpawnTimer<=0&&(this.demoBoulders.push({x:30+Math.random()*(t-60),y:-20,vy:1.5+Math.random(),radius:12+Math.random()*10,rotation:Math.random()*Math.PI*2,health:2}),this.demoSpawnTimer=700+Math.random()*400);for(let s=this.demoBullets.length-1;s>=0;s--){const n=this.demoBullets[s];n.y+=n.vy,n.y<-10&&this.demoBullets.splice(s,1)}for(let s=this.demoBoulders.length-1;s>=0;s--){const n=this.demoBoulders[s];n.y+=n.vy,n.rotation+=.02,n.y>i+30&&this.demoBoulders.splice(s,1)}for(let s=this.demoParticles.length-1;s>=0;s--){const n=this.demoParticles[s];n.x+=n.vx,n.y+=n.vy,n.vy+=.2,n.life-=.04,n.life<=0&&this.demoParticles.splice(s,1)}for(let s=this.demoBullets.length-1;s>=0;s--){const n=this.demoBullets[s];for(let a=this.demoBoulders.length-1;a>=0;a--){const o=this.demoBoulders[a];if(Math.sqrt((n.x-o.x)**2+(n.y-o.y)**2)<o.radius+4){if(o.health--,this.demoBullets.splice(s,1),o.health<=0){for(let h=0;h<6;h++){const d=Math.random()*Math.PI*2,g=2+Math.random()*3;this.demoParticles.push({x:o.x,y:o.y,vx:Math.cos(d)*g,vy:Math.sin(d)*g,life:1,size:3+Math.random()*4})}this.demoBoulders.splice(a,1)}break}}}}renderDemoAnimation(){if(!this.demoCanvas||!this.demoCtx)return;const e=this.demoCtx,t=this.demoCanvas.width,i=this.demoCanvas.height,s=e.createLinearGradient(0,0,0,i);s.addColorStop(0,"#1a2530"),s.addColorStop(1,"#0d1520"),e.fillStyle=s,e.fillRect(0,0,t,i),e.strokeStyle="rgba(60, 80, 90, 0.1)",e.lineWidth=1;for(let o=0;o<t;o+=20)e.beginPath(),e.moveTo(o,0),e.lineTo(o,i),e.stroke();e.fillStyle="#2a3a30",e.fillRect(0,i-15,t,15);for(const o of this.demoBoulders)e.save(),e.translate(o.x,o.y),e.rotate(o.rotation),e.fillStyle="#5a4a3a",e.beginPath(),e.arc(0,0,o.radius,0,Math.PI*2),e.fill(),e.strokeStyle="#7a6a5a",e.lineWidth=2,e.stroke(),e.restore();e.fillStyle="#ffd54f";for(const o of this.demoBullets)e.beginPath(),e.arc(o.x,o.y,4,0,Math.PI*2),e.fill();for(const o of this.demoParticles)e.globalAlpha=o.life,e.fillStyle="#8a7a6a",e.beginPath(),e.arc(o.x,o.y,o.size*o.life,0,Math.PI*2),e.fill();e.globalAlpha=1;const n=this.demoCannonX,a=i-22;e.fillStyle="#3a4a40",e.beginPath(),e.arc(n-15,a+5,8,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(n+15,a+5,8,0,Math.PI*2),e.fill(),e.fillStyle="#4a5a50",e.beginPath(),e.roundRect(n-20,a-8,40,16,4),e.fill(),e.fillStyle="#5a6a60",e.beginPath(),e.roundRect(n-5,a-30,10,25,3),e.fill()}gameLoop(e){const t=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.update(t),this.render(),this.gameState==="START"&&(this.updateDemoAnimation(t),this.renderDemoAnimation()),requestAnimationFrame(i=>this.gameLoop(i))}update(e){if(this.screenShake.intensity>0&&(this.screenShake.x=(Math.random()-.5)*this.screenShake.intensity*12,this.screenShake.y=(Math.random()-.5)*this.screenShake.intensity*12,this.screenShake.intensity*=.88,this.screenShake.intensity<.01&&(this.screenShake.intensity=0,this.screenShake.x=0,this.screenShake.y=0)),this.particles.update(e),this.floatingText.update(e),this.gameState==="PLAYING"){if(this.updateCannon(e),this.updateBullets(e),this.updateBoulders(e),this.checkCollisions(),this.isFiring){const s=r.BASE_FIRE_INTERVAL*this.getFireRateMultiplier();this.fireTimer-=e*1e3,this.fireTimer<=0&&(this.fireBullets(),this.fireTimer=s)}const t=this.getDifficultyMultiplier(),i=Math.max(r.BOULDER_SPAWN_INTERVAL_MIN,(r.BOULDER_SPAWN_INTERVAL_START-this.totalDestroyed*25)/t);this.spawnTimer-=e*1e3,this.spawnTimer<=0&&(this.spawnBoulder(),this.spawnTimer=i),this.updateHUD(),this.updateShieldRecharge(e)}}render(){const e=this.ctx;e.save(),e.translate(this.screenShake.x,this.screenShake.y),this.drawBackground(),this.drawGround(),(this.gameState==="PLAYING"||this.gameState==="PAUSED"||this.gameState==="UPGRADE"||this.gameState==="GAME_OVER")&&(this.drawBoulders(),this.drawBullets(),this.drawCannon(),this.particles.draw(e),this.floatingText.draw(e)),e.restore()}}window.addEventListener("DOMContentLoaded",()=>{console.log("[main] Initializing Cannon Blaster"),new H});</script>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>

        <!-- Top Bar -->
        <div id="top-bar">
            <button id="settingsBtn" class="hud-btn">
                <svg viewBox="0 0 24 24">
                    <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
                </svg>
            </button>

            <!-- HUD stats -->
            <div id="hud" class="hidden">
                <div class="hud-left">
                    <div class="hud-label">Score</div>
                    <div class="hud-value" id="scoreDisplay">0</div>
                </div>
                <div class="hud-center">
                    <div class="progress-bar-container">
                        <div class="progress-bar-bg">
                            <div class="progress-bar-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text" id="progressText">0/12</div>
                    </div>
                </div>
                <div class="hud-right">
                    <div class="hud-label">Destroyed</div>
                    <div class="hud-value" id="destroyedDisplay">0</div>
                </div>
            </div>

            <button id="pauseBtn" class="hud-btn hidden">
                <svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
            </button>
        </div>

        <!-- Upgrade Indicators -->
        <div class="upgrade-indicators">
            <div class="upgrade-dots" data-tree="fire">
                <div class="dots-row" id="fireDotsRow"></div>
                <div class="label">Fire</div>
            </div>
            <div class="upgrade-dots" data-tree="utility">
                <div class="dots-row" id="utilityDotsRow"></div>
                <div class="label">Utility</div>
            </div>
            <div class="upgrade-dots" data-tree="defense">
                <div class="dots-row" id="defenseDotsRow"></div>
                <div class="label">Defense</div>
            </div>
        </div>

        <!-- Start Screen -->
        <div id="startScreen" class="overlay">
            <div class="content">
                <h1 class="title">Cannon Blaster</h1>
                <p class="subtitle">Defend the Base</p>

                <div class="demo-container">
                    <canvas id="demoCanvas"></canvas>
                </div>

                <div class="start-buttons">
                    <button class="btn" id="startButton">Battle</button>
                </div>
            </div>
        </div>

        <!-- Tactical Schematic Upgrade Screen -->
        <div id="upgradeScreen" class="overlay hidden">
            <div class="scanline-overlay"></div>
            <div class="scanning-bar"></div>
            
            <div class="content">
                <div class="upgrade-header">
                    <h2 class="upgrade-title">Tech Schematic</h2>
                    <p class="upgrade-subtitle">System Upgrade Required</p>
                </div>

                <div class="schematic-grid" id="schematicGrid">
                    <!-- FIRE POWER PILLAR -->
                    <div class="pillar pillar-fire" style="--p-color: #ffaa00; --p-rgb: 255, 170, 0;">
                        <div class="pillar-label">Firepower</div>
                        <div id="pillarFire"></div>
                    </div>

                    <!-- UTILITY PILLAR -->
                    <div class="pillar pillar-utility" style="--p-color: #00ccff; --p-rgb: 0, 204, 255;">
                        <div class="pillar-label">Utility</div>
                        <div id="pillarUtility"></div>
                    </div>

                    <!-- DEFENSE PILLAR -->
                    <div class="pillar pillar-defense" style="--p-color: #44ff88; --p-rgb: 68, 255, 136;">
                        <div class="pillar-label">Defense</div>
                        <div id="pillarDefense"></div>
                    </div>
                </div>

                <div class="module-details" id="moduleDetails">
                    <div class="details-header">
                        <div class="details-name" id="detailsName">Select Module</div>
                        <div class="details-tier" id="detailsTier">Tier --</div>
                    </div>
                    <div class="details-desc" id="detailsDesc">Click on an available module to see technical specifications.</div>
                    <div class="details-warning" id="detailsWarning">Warning: Selecting this branch will offline sibling modules.</div>
                </div>

                <div class="upgrade-footer">
                    <button class="btn" id="installBtn">Initiate Install</button>
                </div>
            </div>
        </div>

        <!-- Pause Screen -->
        <div id="pauseScreen" class="overlay hidden">
            <div class="content">
                <h2 class="pause-title">Paused</h2>
                <div class="pause-buttons">
                    <button class="btn" id="resumeButton">Resume</button>
                    <button class="btn btn-secondary" id="pauseRestartBtn">Restart</button>
                    <button class="btn btn-secondary" id="pauseMenuBtn">Menu</button>
                </div>
            </div>
        </div>

        <!-- Game Over Screen -->
        <div id="gameOverScreen" class="overlay hidden">
            <div class="content">
                <h2 class="game-over-title">Game Over</h2>

                <div class="final-stats">
                    <div class="stat-row">
                        <span class="stat-label">Final Score</span>
                        <span class="stat-value" id="finalScore">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Boulders Destroyed</span>
                        <span class="stat-value" id="finalDestroyed">0</span>
                    </div>
                    <div class="upgrade-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="summaryRate">0</div>
                            <div class="summary-label">Fire</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryPower">0</div>
                            <div class="summary-label">Utility</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="summaryMulti">0</div>
                            <div class="summary-label">Defense</div>
                        </div>
                    </div>
                </div>

                <div class="game-over-buttons">
                    <button class="btn" id="restartButton">Try Again</button>
                    <button class="btn btn-secondary" id="menuButton">Menu</button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden">
            <h3 class="settings-title">Settings</h3>
            <div class="settings-row">
                <span class="settings-label">Music</span>
                <div class="toggle active" id="musicToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Sound FX</span>
                <div class="toggle active" id="fxToggle"></div>
            </div>
            <div class="settings-row">
                <span class="settings-label">Haptics</span>
                <div class="toggle active" id="hapticToggle"></div>
            </div>
            <button class="btn settings-close" id="settingsClose">Done</button>
        </div>
    </div>

</body>
</html>
