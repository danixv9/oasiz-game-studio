<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Threes!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Nunito:wght@400;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: #f5f0e8;
            color: #5a5a5a;
            font-family: 'Quicksand', 'Nunito', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: #ebe5db; /* Softer cream grid background */
        }

        /* HUD Overlay */

        #hud {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 30px 40px;
            pointer-events: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 5;
        }

        .score-container {
            background: rgba(255,255,255,0.7);
            border-radius: 20px;
            padding: 15px 30px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(0,0,0,0.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.05);
            min-width: 120px;
        }

        .score-label {
            font-size: 0.7rem;
            font-weight: 700;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 4px;
        }

        .score-value {
            font-family: 'Quicksand', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #5a5a5a;
            line-height: 1;
        }

        .score-container.best {
            background: rgba(240, 210, 100, 0.15); /* Soft gold tint */
            border: 2px solid rgba(240, 210, 100, 0.2);
        }

        .score-container.best .score-label {
            color: #d4b545;
        }

        .score-container.best .score-value {
            color: #b09530;
        }

        .hud-center {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .next-label {
            font-size: 0.8rem;
            font-weight: 700;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 4px;
        }

        .next-tile-preview {
            width: 60px;
            height: 80px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            border: 3px solid #fff;
            background: #fff;
        }

        .score-value.bump {
            animation: scoreBump 0.2s ease;
        }

        @keyframes scoreBump {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Overlays */

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f5f0e8 0%, #ebe5db 50%, #f0ebe3 100%);
            z-index: 10;
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .overlay.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .content {
            text-align: center;
            padding: 40px;
            max-width: 90%;
        }

        /* Logo / Title */

        .game-logo {
            margin-bottom: 20px;
        }

        .logo-tiles {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 24px;
        }

        .logo-tile {
            width: 60px;
            height: 60px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #666;
            animation: logoFloat 2.5s ease-in-out infinite;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .logo-tile.blue { background: linear-gradient(145deg, #7ec8e3, #6ab8d3); color: #fff; animation-delay: 0s; }

        .logo-tile.purple { background: linear-gradient(145deg, #c5b8e8, #b1a4d4); color: #fff; animation-delay: 0.15s; }

        .logo-tile.white { background: linear-gradient(145deg, #ffffff, #f5f0e8); color: #5a5a5a; animation-delay: 0.3s; border: 2px solid #ebe5db; }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }

        h1 {
            font-family: 'Quicksand', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #5a5a5a;
            letter-spacing: 4px;
        }

        .subtitle {
            font-size: 1rem;
            color: #999;
            margin-bottom: 40px;
            font-weight: 500;
        }

        /* Buttons */

        .btn {
            background: linear-gradient(145deg, #7ec8e3, #5ab8d8);
            color: #fff;
            border: none;
            padding: 16px 56px;
            font-family: 'Quicksand', sans-serif;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 50px;
            box-shadow: 0 6px 24px rgba(126, 200, 227, 0.4);
            transition: all 0.3s ease;
            letter-spacing: 1px;
            text-transform: lowercase;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(126, 200, 227, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #ffb5ba, #f5a0a5);
            box-shadow: 0 6px 24px rgba(255, 181, 186, 0.4);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 30px rgba(255, 181, 186, 0.5);
        }

        .btn-gallery {
            background: linear-gradient(145deg, #c5b8e8, #a898d8);
            box-shadow: 0 6px 24px rgba(197, 184, 232, 0.4);
        }

        #startScreen .btn-gallery {
            margin-top: 12px;
        }

        .btn-gallery:hover {
            box-shadow: 0 8px 30px rgba(197, 184, 232, 0.5);
        }

        /* How to Play */

        .how-to-play {
            margin-top: 36px;
            padding: 20px 28px;
            background: rgba(255,255,255,0.6);
            border-radius: 20px;
            border: 2px solid rgba(200,190,180,0.2);
        }

        .how-to-play h3 {
            font-family: 'Quicksand', sans-serif;
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 16px;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: lowercase;
        }

        .instructions {
            display: flex;
            justify-content: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .instruction {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: #777;
            font-weight: 500;
        }

        .instruction-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.8rem;
        }

        .icon-swipe { background: #7ec8e3; color: #fff; }

        .icon-merge { background: #c5b8e8; color: #fff; }

        .icon-score { background: #f0d264; color: #fff; }

        /* Game Over Screen */

        #gameOverScreen .content {
            animation: gameOverSlideIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes gameOverSlideIn {
            0% {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .game-over-title {
            font-family: 'Quicksand', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: #5a5a5a;
            letter-spacing: 3px;
        }

        .game-over-subtitle {
            font-size: 1rem;
            color: #999;
            margin-bottom: 30px;
        }

        .final-score-container {
            margin: 30px 0;
            padding: 24px 40px;
            background: rgba(255,255,255,0.8);
            border-radius: 24px;
            border: 2px solid rgba(200,190,180,0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.06);
        }

        .final-score-label {
            font-size: 0.8rem;
            color: #aaa;
            text-transform: lowercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .final-score {
            font-family: 'Quicksand', sans-serif;
            font-size: 4rem;
            font-weight: 700;
            color: #5a5a5a;
        }

        .highest-tile {
            margin-top: 16px;
            padding: 12px 24px;
            background: linear-gradient(145deg, #f5a962, #e08b3d);
            border-radius: 30px;
            display: inline-block;
            color: #fff;
            font-weight: 700;
            font-size: 1rem;
        }

        .stats-row {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin: 28px 0;
        }

        .stat-item {
            text-align: center;
            padding: 16px 20px;
            background: rgba(255,255,255,0.6);
            border-radius: 16px;
            border: 2px solid rgba(200,190,180,0.2);
            min-width: 90px;
            animation: statSlideUp 0.5s ease-out backwards;
        }

        .stat-item:nth-child(1) { animation-delay: 0.1s; }

        .stat-item:nth-child(2) { animation-delay: 0.2s; }

        .stat-item:nth-child(3) { animation-delay: 0.3s; }

        @keyframes statSlideUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        .stat-value {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.8rem;
            font-weight: 700;
            color: #5a5a5a;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #aaa;
            text-transform: lowercase;
            letter-spacing: 1px;
            margin-top: 6px;
        }

        .game-over-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .game-over-buttons .btn {
            min-width: 130px;
        }

        /* Gallery Screen */

        .gallery-content {
            text-align: center;
            padding: 40px 30px;
            max-width: 100%;
            max-height: 100vh;
            overflow-y: auto;
        }

        .gallery-title {
            font-family: 'Quicksand', sans-serif;
            font-size: 2.2rem;
            font-weight: 700;
            color: #5a5a5a;
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .gallery-subtitle {
            font-size: 1rem;
            color: #999;
            margin-bottom: 40px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(5, 80px);
            gap: 24px 24px;
            row-gap: 45px;
            justify-content: center;
            margin: 0 auto 40px auto;
        }

        .gallery-item {
            width: 80px;
            height: 80px;
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: transform 0.2s ease;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .gallery-item.discovered {
            cursor: pointer;
        }

        .gallery-item.discovered:hover {
            transform: scale(1.1);
        }

        .gallery-item.locked {
            background: #d8d4cc !important;
            opacity: 0.6;
        }

        .gallery-item.locked::after {
            content: "?";
            font-family: 'Quicksand', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            color: #b0a89c;
        }

        .gallery-item canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 16px;
        }

        .gallery-character-name {
            position: absolute;
            bottom: -22px;
            font-size: 0.7rem;
            font-weight: 700;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
        }

        .discovery-progress {
            font-size: 1rem;
            color: #888;
            margin-bottom: 28px;
            font-weight: 600;
        }

        .discovery-progress span {
            color: #7ec8e3;
            font-weight: 700;
        }

        /* Audio Controls */

        .audio-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 12px;
            z-index: 20;
        }

        .audio-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            color: #5a5a5a;
        }

        .audio-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
            background: #fff;
        }

        .audio-btn:active {
            transform: translateY(0);
        }

        .audio-btn.muted {
            color: #aaa;
            background: rgba(255, 255, 255, 0.5);
        }

        .audio-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Mobile Adjustments */

        @media (pointer: coarse) {
            h1 {
                font-size: 2.8rem;
            }
            .logo-tile {
                width: 50px;
                height: 50px;
                font-size: 1.5rem;
            }
            .content {
                padding: 28px;
            }
            .btn {
                padding: 14px 48px;
                font-size: 1.1rem;
            }
            .instructions {
                flex-direction: column;
                gap: 12px;
            }
            #hud {
                padding: 50px 16px 12px 16px;
            }
            .score-container {
                padding: 10px 18px;
            }
            .score-value {
                font-size: 1.6rem;
            }
            .next-tile-preview {
                width: 42px;
                height: 42px;
            }
            .stat-value {
                font-size: 1.4rem;
            }
        }

        @media (max-height: 600px) {
            .how-to-play {
                display: none;
            }
            .content {
                padding: 20px;
            }
            h1 {
                font-size: 2.2rem;
            }
            .logo-tile {
                width: 45px;
                height: 45px;
            }
            .gallery-grid {
                grid-template-columns: repeat(5, 60px);
                gap: 16px;
            }
            .gallery-item {
                width: 60px;
                height: 60px;
            }
            .gallery-title {
                font-size: 1.6rem;
            }
            .gallery-subtitle {
                margin-bottom: 28px;
            }
            .gallery-character-name {
                font-size: 0.55rem;
                bottom: -18px;
            }
        }

        @media (max-width: 420px) {
            .gallery-grid {
                grid-template-columns: repeat(5, 55px);
                gap: 12px;
            }
            .gallery-item {
                width: 55px;
                height: 55px;
            }
        }
    </style>
  <script type="module" crossorigin>(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const n of s.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&a(n)}).observe(document,{childList:!0,subtree:!0});function i(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function a(t){if(t.ep)return;t.ep=!0;const s=i(t);fetch(t.href,s)}})();const h={GRID_SIZE:4,SWIPE_THRESHOLD:30,ANIMATION_DURATION:150,MERGE_ANIMATION_DURATION:200,SPAWN_ANIMATION_DURATION:250},T={1:{bg:"#7EC8E3",bgLight:"#7EC8E3",text:"#ffffff",border:"#6AB8D3"},2:{bg:"#C5B8E8",bgLight:"#C5B8E8",text:"#ffffff",border:"#B1A4D4"},3:{bg:"#FFFFFF",bgLight:"#FFFFFF",text:"#5A5A5A",border:"#EBE5DB"},6:{bg:"#A8D8B9",bgLight:"#A8D8B9",text:"#4A6A55",border:"#8EC2A1"},12:{bg:"#E8D1A5",bgLight:"#E8D1A5",text:"#6A5A3A",border:"#D2BB8F"},24:{bg:"#F5A962",bgLight:"#F5A962",text:"#6B4520",border:"#E08B3D"},48:{bg:"#E8736C",bgLight:"#E8736C",text:"#6B2520",border:"#D05550"},96:{bg:"#6BC5D2",bgLight:"#6BC5D2",text:"#1D4A52",border:"#4AABB8"},192:{bg:"#E57BA6",bgLight:"#E57BA6",text:"#5A2040",border:"#CC5A87"},384:{bg:"#B08BD4",bgLight:"#B08BD4",text:"#3A2050",border:"#9066BB"},768:{bg:"#7DCE82",bgLight:"#7DCE82",text:"#2D5A30",border:"#5CB863"},1536:{bg:"#F0D264",bgLight:"#F0D264",text:"#5A4A10",border:"#D4B545"},3072:{bg:"#D986C0",bgLight:"#D986C0",text:"#4A1A3A",border:"#C066A5"},6144:{bg:"#7EB3E0",bgLight:"#7EB3E0",text:"#1A3A5A",border:"#5A95C8"}};function p(g){return T[g]?T[g]:{bg:"#ffffff",bgLight:"#ffffff",text:"#333333",border:"#cccccc"}}function I(g,e,i){return g+(e-g)*i}function b(g){return 1+2.70158*Math.pow(g-1,3)+1.70158*Math.pow(g-1,2)}function E(g){return 1-Math.pow(1-g,3)}class P{ctx=null;musicBuffer=null;musicSource=null;musicGain=null;sfxGain=null;musicEnabled=!0;sfxEnabled=!0;buffersLoaded=!1;constructor(){console.log("[AudioManager] Created"),this.loadState()}init(){if(!this.ctx)try{this.ctx=new(window.AudioContext||window.webkitAudioContext),this.musicGain=this.ctx.createGain(),this.sfxGain=this.ctx.createGain(),this.musicGain.connect(this.ctx.destination),this.sfxGain.connect(this.ctx.destination),this.updateVolumes(),console.log("[AudioManager.init] Audio context initialized"),this.loadMusic()}catch(e){console.warn("[AudioManager.init] Failed to initialize audio:",e)}}loadState(){const e=localStorage.getItem("threes_music_enabled"),i=localStorage.getItem("threes_sfx_enabled");this.musicEnabled=e!=="false",this.sfxEnabled=i!=="false"}saveState(){localStorage.setItem("threes_music_enabled",this.musicEnabled.toString()),localStorage.setItem("threes_sfx_enabled",this.sfxEnabled.toString())}updateVolumes(){this.musicGain&&(this.musicGain.gain.value=this.musicEnabled?.4:0),this.sfxGain&&(this.sfxGain.gain.value=this.sfxEnabled?.6:0)}async loadMusic(){if(this.ctx)try{console.log("[AudioManager.loadMusic] Loading music...");const i=await(await fetch("https://assets.oasiz.ai/audio/threes.mp3")).arrayBuffer();this.musicBuffer=await this.ctx.decodeAudioData(i),this.buffersLoaded=!0,console.log("[AudioManager.loadMusic] Music loaded successfully"),this.musicEnabled&&this.playMusic()}catch(e){console.warn("[AudioManager.loadMusic] Failed to load music:",e)}}playMusic(){this.init(),!(!this.ctx||!this.musicBuffer||!this.musicEnabled)&&(this.stopMusic(),this.musicSource=this.ctx.createBufferSource(),this.musicSource.buffer=this.musicBuffer,this.musicSource.loop=!0,this.musicSource.connect(this.musicGain),this.musicSource.start(0))}stopMusic(){if(this.musicSource){try{this.musicSource.stop()}catch{}this.musicSource=null}}toggleMusic(){return this.musicEnabled=!this.musicEnabled,this.saveState(),this.updateVolumes(),this.musicEnabled?this.playMusic():this.stopMusic(),this.musicEnabled}toggleSFX(){return this.sfxEnabled=!this.sfxEnabled,this.saveState(),this.updateVolumes(),this.sfxEnabled}isMusicEnabled(){return this.musicEnabled}isSFXEnabled(){return this.sfxEnabled}playMoveSFX(){if(this.init(),!this.ctx||!this.sfxEnabled)return;const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.type="square",e.frequency.setValueAtTime(150,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(40,this.ctx.currentTime+.1),i.gain.setValueAtTime(.1,this.ctx.currentTime),i.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.1),e.connect(i),i.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.1)}playMergeSFX(){if(this.init(),!this.ctx||!this.sfxEnabled)return;const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.type="sine",e.frequency.setValueAtTime(440,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(880,this.ctx.currentTime+.15),i.gain.setValueAtTime(.2,this.ctx.currentTime),i.gain.exponentialRampToValueAtTime(.01,this.ctx.currentTime+.2),e.connect(i),i.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.2)}playSpawnSFX(){if(this.init(),!this.ctx||!this.sfxEnabled)return;const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.type="triangle",e.frequency.setValueAtTime(200,this.ctx.currentTime),e.frequency.exponentialRampToValueAtTime(600,this.ctx.currentTime+.1),i.gain.setValueAtTime(.1,this.ctx.currentTime),i.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.1),e.connect(i),i.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.1)}playClickSFX(){if(this.init(),!this.ctx||!this.sfxEnabled)return;const e=this.ctx.createOscillator(),i=this.ctx.createGain();e.type="sine",e.frequency.setValueAtTime(800,this.ctx.currentTime),i.gain.setValueAtTime(.1,this.ctx.currentTime),i.gain.linearRampToValueAtTime(0,this.ctx.currentTime+.05),e.connect(i),i.connect(this.sfxGain),e.start(),e.stop(this.ctx.currentTime+.05)}}class v{deck=[];lastDrawn=0;constructor(){this.refillDeck()}refillDeck(){this.deck=[1,1,1,1,2,2,2,3,3,3],this.shuffle(),console.log("[TileDeck.refillDeck] New deck:",this.deck.join(", "))}shuffle(){for(let e=this.deck.length-1;e>0;e--){const i=Math.floor(Math.random()*(e+1));[this.deck[e],this.deck[i]]=[this.deck[i],this.deck[e]]}}draw(){this.deck.length===0&&this.refillDeck();let e=this.deck.pop();return e!==1&&e===this.lastDrawn&&this.deck.length>0&&(this.deck.unshift(e),this.shuffle(),e=this.deck.pop()),this.lastDrawn=e,console.log("[TileDeck.draw] Drew:",e,"Remaining:",this.deck.length),e}peek(){return this.deck.length===0&&this.refillDeck(),this.deck[this.deck.length-1]}}class w{canvas;ctx;state;cellSize=0;gridOffsetX=0;gridOffsetY=0;gridPadding=8;cellGap=8;audio;touchStartX=0;touchStartY=0;touchEndX=0;touchEndY=0;isTouching=!1;slideAnimations=[];lastMovedLines=new Set;lastMoveDirection=null;lastTime=0;isMobile;tileDeck;constructor(){console.log("[ThreesGame] Initializing game"),this.canvas=document.getElementById("gameCanvas"),this.ctx=this.canvas.getContext("2d"),this.isMobile=window.matchMedia("(pointer: coarse)").matches,this.tileDeck=new v,this.audio=new P,this.state=this.createInitialState(),this.setupEventListeners(),this.resizeCanvas(),window.addEventListener("resize",()=>this.resizeCanvas()),requestAnimationFrame(e=>this.gameLoop(e))}createInitialState(){console.log("[ThreesGame.createInitialState]");const e=[];for(let i=0;i<h.GRID_SIZE;i++){e[i]=[];for(let a=0;a<h.GRID_SIZE;a++)e[i][a]=null}return{grid:e,nextTileValue:this.generateNextTileValue(),score:0,highScore:this.loadHighScore(),movesMade:0,mergesMade:0,highestTile:0,gameOver:!1,started:!1,animating:!1}}loadHighScore(){try{return parseInt(localStorage.getItem("threes_highscore")||"0",10)}catch{return 0}}saveHighScore(e){try{localStorage.setItem("threes_highscore",e.toString())}catch{}}generateNextTileValue(){return this.tileDeck.draw()}resizeCanvas(){console.log("[ThreesGame.resizeCanvas]");const e=Math.min(window.devicePixelRatio||1,2);this.canvas.width=window.innerWidth*e,this.canvas.height=window.innerHeight*e,this.canvas.style.width=window.innerWidth+"px",this.canvas.style.height=window.innerHeight+"px",this.ctx.setTransform(e,0,0,e,0,0),this.calculateLayout()}calculateLayout(){const e=window.innerWidth,i=window.innerHeight,a=this.isMobile?100:80,t=this.isMobile?40:60,s=e-40,n=i-a-t,r=Math.min(s,n,500),l=(h.GRID_SIZE-1)*this.cellGap+this.gridPadding*2;this.cellSize=(r-l)/h.GRID_SIZE;const o=h.GRID_SIZE*this.cellSize+(h.GRID_SIZE-1)*this.cellGap+this.gridPadding*2,d=o;this.gridOffsetX=(e-o)/2,this.gridOffsetY=a+(n-d)/2,console.log("[ThreesGame.calculateLayout] cellSize:",this.cellSize)}setupEventListeners(){console.log("[ThreesGame.setupEventListeners]"),document.getElementById("startButton")?.addEventListener("click",()=>{this.audio.playClickSFX(),this.startGame()}),document.getElementById("restartButton")?.addEventListener("click",()=>{this.audio.playClickSFX(),this.startGame()}),document.getElementById("galleryButton")?.addEventListener("click",()=>{this.audio.playClickSFX(),this.showGallery()}),document.getElementById("gameOverGalleryButton")?.addEventListener("click",()=>{this.audio.playClickSFX(),this.showGalleryFromGameOver()}),document.getElementById("galleryBackButton")?.addEventListener("click",()=>{this.audio.playClickSFX(),this.hideGallery()}),document.getElementById("musicToggle")?.addEventListener("click",()=>{this.audio.toggleMusic(),this.updateAudioButtons(),this.audio.playClickSFX()}),document.getElementById("sfxToggle")?.addEventListener("click",()=>{this.audio.toggleSFX(),this.updateAudioButtons(),this.audio.playClickSFX()}),this.updateAudioButtons(),this.canvas.addEventListener("mousedown",e=>this.onPointerDown(e.clientX,e.clientY)),this.canvas.addEventListener("mousemove",e=>this.onPointerMove(e.clientX,e.clientY)),this.canvas.addEventListener("mouseup",()=>this.onPointerUp()),this.canvas.addEventListener("touchstart",e=>{e.preventDefault();const i=e.touches[0];this.onPointerDown(i.clientX,i.clientY)},{passive:!1}),this.canvas.addEventListener("touchmove",e=>{e.preventDefault();const i=e.touches[0];this.onPointerMove(i.clientX,i.clientY)},{passive:!1}),this.canvas.addEventListener("touchend",e=>{e.preventDefault(),this.onPointerUp()},{passive:!1}),window.addEventListener("keydown",e=>this.onKeyDown(e))}updateAudioButtons(){const e=document.getElementById("musicToggle"),i=document.getElementById("sfxToggle");if(e){const a=this.audio.isMusicEnabled();e.classList.toggle("muted",!a),document.getElementById("musicOnIcon").style.display=a?"block":"none",document.getElementById("musicOffIcon").style.display=a?"none":"block"}if(i){const a=this.audio.isSFXEnabled();i.classList.toggle("muted",!a),document.getElementById("sfxOnIcon").style.display=a?"block":"none",document.getElementById("sfxOffIcon").style.display=a?"none":"block"}}startGame(){console.log("[ThreesGame.startGame]"),this.audio.playMusic(),this.tileDeck=new v,this.state=this.createInitialState(),this.state.started=!0,this.state.highScore=this.loadHighScore(),this.spawnInitialTiles(),document.getElementById("startScreen")?.classList.add("hidden"),document.getElementById("gameOverScreen")?.classList.add("hidden"),document.getElementById("hud").style.display="flex",this.updateHUD(),this.updateNextTilePreview()}spawnInitialTiles(){console.log("[ThreesGame.spawnInitialTiles]");const e=[];for(let a=0;a<h.GRID_SIZE;a++)for(let t=0;t<h.GRID_SIZE;t++)e.push([t,a]);for(let a=e.length-1;a>0;a--){const t=Math.floor(Math.random()*(a+1));[e[a],e[t]]=[e[t],e[a]]}const i=[1,2];for(let a=0;a<i.length;a++){const[t,s]=e[a],n=i[a];this.state.grid[s][t]=this.createTile(n,t,s),this.state.highestTile=Math.max(this.state.highestTile,n)}}createTile(e,i,a,t=!1){return{value:e,x:i,y:a,animX:i,animY:a,scale:t?0:1,targetScale:1,merging:!1,spawning:t,spawnProgress:t?0:1}}onPointerDown(e,i){!this.state.started||this.state.gameOver||this.state.animating||(this.touchStartX=e,this.touchStartY=i,this.touchEndX=e,this.touchEndY=i,this.isTouching=!0)}onPointerMove(e,i){this.isTouching&&(this.touchEndX=e,this.touchEndY=i)}onPointerUp(){if(!this.isTouching||!this.state.started||this.state.gameOver||this.state.animating){this.isTouching=!1;return}const e=this.detectSwipe(this.touchEndX,this.touchEndY);this.isTouching=!1,e&&this.performMove(e)}onKeyDown(e){if(!this.state.started||this.state.gameOver||this.state.animating)return;let i=null;switch(e.key){case"ArrowUp":case"w":case"W":i="up";break;case"ArrowDown":case"s":case"S":i="down";break;case"ArrowLeft":case"a":case"A":i="left";break;case"ArrowRight":case"d":case"D":i="right";break}i&&(e.preventDefault(),this.performMove(i))}detectSwipe(e,i){const a=e-this.touchStartX,t=i-this.touchStartY,s=Math.abs(a),n=Math.abs(t);return Math.max(s,n)<h.SWIPE_THRESHOLD?null:s>n?a>0?"right":"left":t>0?"down":"up"}performMove(e){console.log("[ThreesGame.performMove]",e),this.slideTiles(e)&&(this.state.movesMade++,this.state.animating=!0,this.audio.playMoveSFX(),setTimeout(()=>{this.spawnNewTile(e),this.state.animating=!1,this.calculateScore(),this.updateHUD(),this.state.nextTileValue=this.generateNextTileValue(),this.updateNextTilePreview(),this.checkGameOver()&&this.endGame()},h.ANIMATION_DURATION+50))}slideTiles(e){let i=!1;this.slideAnimations=[],this.lastMovedLines=new Set,this.lastMoveDirection=e;const a=e==="left"?-1:e==="right"?1:0,t=e==="up"?-1:e==="down"?1:0,s=new Set,n=[];for(let r=0;r<h.GRID_SIZE;r++)for(let l=0;l<h.GRID_SIZE;l++)n.push([l,r]);e==="right"?n.sort((r,l)=>l[0]-r[0]):e==="left"?n.sort((r,l)=>r[0]-l[0]):e==="down"?n.sort((r,l)=>l[1]-r[1]):e==="up"&&n.sort((r,l)=>r[1]-l[1]);for(const[r,l]of n){const o=this.state.grid[l][r];if(!o)continue;const d=r+a,u=l+t;if(d<0||d>=h.GRID_SIZE||u<0||u>=h.GRID_SIZE)continue;const f=this.state.grid[u][d];if(f===null)this.state.grid[u][d]=o,this.state.grid[l][r]=null,o.x=d,o.y=u,e==="left"||e==="right"?this.lastMovedLines.add(l):this.lastMovedLines.add(r),this.slideAnimations.push({tile:o,fromX:r,fromY:l,toX:d,toY:u,progress:0,merged:!1}),i=!0;else if(this.canMerge(o,f)&&!s.has(f)){const m=o.value+f.value;this.state.grid[l][r]=null,f.value=m,f.merging=!0,f.scale=1,f.targetScale=1.2,s.add(f),this.state.mergesMade++,this.state.highestTile=Math.max(this.state.highestTile,m),this.audio.playMergeSFX(),e==="left"||e==="right"?this.lastMovedLines.add(l):this.lastMovedLines.add(r),this.slideAnimations.push({tile:o,fromX:r,fromY:l,toX:d,toY:u,progress:0,merged:!0}),setTimeout(()=>{f.targetScale=1,f.merging=!1},h.MERGE_ANIMATION_DURATION),i=!0}}return i}canMerge(e,i){return e.value===1&&i.value===2||e.value===2&&i.value===1||e.value>=3&&e.value===i.value}spawnNewTile(e){if(console.log("[ThreesGame.spawnNewTile]",e),this.lastMovedLines.size===0){console.log("[ThreesGame.spawnNewTile] No moved lines, skipping spawn");return}const i=[];for(const n of this.lastMovedLines){let r,l;switch(e){case"left":r=h.GRID_SIZE-1,l=n;break;case"right":r=0,l=n;break;case"up":r=n,l=h.GRID_SIZE-1;break;case"down":r=n,l=0;break}this.state.grid[l][r]===null&&i.push([r,l])}if(i.length===0){console.log("[ThreesGame.spawnNewTile] No valid spawn positions");return}const[a,t]=i[Math.floor(Math.random()*i.length)],s=this.createTile(this.state.nextTileValue,a,t,!0);this.state.grid[t][a]=s,this.state.highestTile=Math.max(this.state.highestTile,this.state.nextTileValue),this.audio.playSpawnSFX(),console.log("[ThreesGame.spawnNewTile] Spawned",this.state.nextTileValue,"at",a,t)}checkGameOver(){for(let e=0;e<h.GRID_SIZE;e++)for(let i=0;i<h.GRID_SIZE;i++)if(this.state.grid[e][i]===null)return!1;for(let e=0;e<h.GRID_SIZE;e++)for(let i=0;i<h.GRID_SIZE;i++){const a=this.state.grid[e][i];if(a){if(i<h.GRID_SIZE-1){const t=this.state.grid[e][i+1];if(t&&this.canMerge(a,t))return!1}if(e<h.GRID_SIZE-1){const t=this.state.grid[e+1][i];if(t&&this.canMerge(a,t))return!1}}}return console.log("[ThreesGame.checkGameOver] No valid moves!"),!0}calculateScore(){let e=0;for(let i=0;i<h.GRID_SIZE;i++)for(let a=0;a<h.GRID_SIZE;a++){const t=this.state.grid[i][a];if(t&&t.value>=3){const s=Math.log(t.value/3)/Math.log(2)+1;e+=Math.pow(3,s)}}this.state.score=Math.round(e)}endGame(){console.log("[ThreesGame.endGame] Final score:",this.state.score),this.state.gameOver=!0,typeof window.submitScore=="function"&&(window.submitScore(this.state.score),console.log("[ThreesGame.endGame] Score submitted:",this.state.score)),this.state.score>this.state.highScore&&(this.state.highScore=this.state.score,this.saveHighScore(this.state.score)),document.getElementById("finalScore").textContent=this.state.score.toString(),document.getElementById("movesMade").textContent=this.state.movesMade.toString(),document.getElementById("mergesMade").textContent=this.state.mergesMade.toString(),document.getElementById("highestTile").textContent="highest: "+this.state.highestTile,setTimeout(()=>{document.getElementById("gameOverScreen")?.classList.remove("hidden")},500)}updateHUD(){const e=document.getElementById("score"),i=parseInt(e.textContent||"0",10),a=this.state.score;e.textContent=a.toString(),document.getElementById("highScore").textContent=this.state.highScore.toString(),a>i&&(e.classList.remove("bump"),e.offsetWidth,e.classList.add("bump"))}updateNextTilePreview(){const e=document.getElementById("nextTilePreview"),i=p(this.state.nextTileValue);e.style.background="linear-gradient(145deg, "+i.bg+", "+i.bgLight+")",e.style.border="2px solid "+i.border,e.innerHTML='<span style="color: '+i.text+'; font-family: Quicksand; font-weight: 700; font-size: 1.4rem;">'+this.state.nextTileValue+"</span>",e.classList.remove("bounce"),e.offsetWidth,e.classList.add("bounce")}gameLoop(e){const i=Math.min((e-this.lastTime)/1e3,.1);this.lastTime=e,this.update(i),this.render(),requestAnimationFrame(a=>this.gameLoop(a))}update(e){for(let i=this.slideAnimations.length-1;i>=0;i--){const a=this.slideAnimations[i];if(a.progress+=e/(h.ANIMATION_DURATION/1e3),a.progress>=1)a.progress=1,a.tile.animX=a.toX,a.tile.animY=a.toY,this.slideAnimations.splice(i,1);else{const t=E(a.progress);a.tile.animX=I(a.fromX,a.toX,t),a.tile.animY=I(a.fromY,a.toY,t)}}for(let i=0;i<h.GRID_SIZE;i++)for(let a=0;a<h.GRID_SIZE;a++){const t=this.state.grid[i][a];t&&(this.slideAnimations.length===0&&(t.animX=t.x,t.animY=t.y),t.spawning&&(t.spawnProgress+=e/(h.SPAWN_ANIMATION_DURATION/1e3),t.spawnProgress>=1?(t.spawnProgress=1,t.spawning=!1,t.scale=1):t.scale=b(t.spawnProgress)),t.merging?t.scale=I(t.scale,t.targetScale,.3):t.scale=I(t.scale,1,.2))}this.isTouching}render(){const e=this.ctx,i=window.innerWidth,a=window.innerHeight;e.fillStyle="#f5f0e8",e.fillRect(0,0,i,a),this.state.started&&this.renderGrid(e)}renderGrid(e){const i=h.GRID_SIZE*this.cellSize+(h.GRID_SIZE-1)*this.cellGap+this.gridPadding*2,a=i;e.fillStyle="#DED6C8",this.roundRect(e,this.gridOffsetX,this.gridOffsetY,i,a,16),e.fill(),e.strokeStyle="rgba(0,0,0,0.05)",e.lineWidth=4,this.roundRect(e,this.gridOffsetX,this.gridOffsetY,i,a,16),e.stroke();for(let t=0;t<h.GRID_SIZE;t++)for(let s=0;s<h.GRID_SIZE;s++){const n=this.gridOffsetX+this.gridPadding+s*(this.cellSize+this.cellGap),r=this.gridOffsetY+this.gridPadding+t*(this.cellSize+this.cellGap);e.fillStyle="#EDE6D9",this.roundRect(e,n,r,this.cellSize,this.cellSize,10),e.fill()}for(let t=0;t<h.GRID_SIZE;t++)for(let s=0;s<h.GRID_SIZE;s++){const n=this.state.grid[t][s];n&&this.renderTile(e,n)}}renderTile(e,i){const a=this.gridOffsetX+this.gridPadding+i.animX*(this.cellSize+this.cellGap),t=this.gridOffsetY+this.gridPadding+i.animY*(this.cellSize+this.cellGap),s=a+this.cellSize/2,n=t+this.cellSize/2,r=12;e.save(),e.translate(s,n),e.scale(i.scale,i.scale),e.translate(-s,-n);const l=p(i.value);e.shadowColor="rgba(0,0,0,0.25)",e.shadowBlur=8,e.shadowOffsetY=3,e.fillStyle=l.bg,this.roundRect(e,a,t,this.cellSize,this.cellSize,r),e.fill(),e.shadowBlur=0,e.shadowOffsetY=0;const o=this.cellSize*.08;e.fillStyle=l.border,e.beginPath(),e.moveTo(a+r,t+this.cellSize),e.lineTo(a+this.cellSize-r,t+this.cellSize),e.quadraticCurveTo(a+this.cellSize,t+this.cellSize,a+this.cellSize,t+this.cellSize-r),e.lineTo(a+this.cellSize,t+this.cellSize-o),e.lineTo(a,t+this.cellSize-o),e.lineTo(a,t+this.cellSize-r),e.quadraticCurveTo(a,t+this.cellSize,a+r,t+this.cellSize),e.closePath(),e.fill(),this.renderTileFace(e,i,a,t),e.restore()}renderTileFace(e,i,a,t){const s=p(i.value),n=a+this.cellSize/2,r=t+this.cellSize/2,l=this.cellSize;if(i.value<=3){const d=l*.5;e.font="700 "+d+"px Quicksand, sans-serif",e.textAlign="center",e.textBaseline="middle",e.fillStyle=s.text,e.fillText(i.value.toString(),n,r);return}if(this.markDiscovered(i.value),i.value===6){this.draw6Face(e,n,r,l,s.text),this.drawNumber(e,n,t,l,i.value,s.text);return}if(i.value===12){this.draw12Face(e,n,r,l,s.text),this.drawNumber(e,n,t,l,i.value,s.text);return}const o=r-l*.08;i.value===24?this.drawChefCharacter(e,n,o,l,s.text):i.value===48?this.drawCoolCharacter(e,n,o,l,s.text):i.value===96?this.drawPirateCharacter(e,n,o,l,s.text):i.value===192?this.drawAlienCharacter(e,n,o,l,s.text):i.value===384?this.drawRobotCharacter(e,n,o,l,s.text):i.value===768?this.drawWizardCharacter(e,n,o,l,s.text):i.value===1536?this.drawKingCharacter(e,n,o,l,s.text):i.value===3072?this.drawNinjaCharacter(e,n,o,l,s.text):i.value===6144?this.drawAstronautCharacter(e,n,o,l,s.text):this.drawLegendCharacter(e,n,o,l,s.text),this.drawNumber(e,n,t,l,i.value,s.text)}draw6Face(e,i,a,t,s){const n=a-t*.1,r=t*.15,l=t*.05;e.fillStyle=s,e.beginPath(),e.arc(i-r,n,l,0,Math.PI*2),e.arc(i+r,n,l,0,Math.PI*2),e.fill(),e.strokeStyle=s,e.lineWidth=t*.03,e.lineCap="round",e.beginPath(),e.arc(i,n+t*.02,t*.08,.15*Math.PI,.85*Math.PI),e.stroke()}draw12Face(e,i,a,t,s){const n=a-t*.1,r=t*.15,l=t*.06;e.strokeStyle=s,e.lineWidth=t*.04,e.lineCap="round",e.beginPath(),e.arc(i-r,n+t*.02,l,1.1*Math.PI,1.9*Math.PI),e.stroke(),e.beginPath(),e.arc(i+r,n+t*.02,l,1.1*Math.PI,1.9*Math.PI),e.stroke(),e.beginPath(),e.arc(i-t*.025,n+t*.08,t*.035,0,Math.PI),e.stroke(),e.beginPath(),e.arc(i+t*.025,n+t*.08,t*.035,0,Math.PI),e.stroke()}drawNumber(e,i,a,t,s,n){const r=t*(s>=1e3?.22:s>=100?.26:.3);e.font="700 "+r+"px Quicksand, sans-serif",e.textAlign="center",e.textBaseline="bottom",e.fillStyle=n,e.fillText(s.toString(),i,a+t-t*.06)}drawBlush(e,i,a,t){}drawKawaiiEyes(e,i,a,t,s,n="normal"){const r=t*.18,l=t*.07;e.fillStyle=s,n==="sparkle"?(this.drawStar(e,i-r,a,l,4),this.drawStar(e,i+r,a,l,4)):n==="happy"?(e.strokeStyle=s,e.lineWidth=t*.04,e.lineCap="round",e.beginPath(),e.arc(i-r,a+t*.02,l,1.1*Math.PI,1.9*Math.PI),e.stroke(),e.beginPath(),e.arc(i+r,a+t*.02,l,1.1*Math.PI,1.9*Math.PI),e.stroke()):(e.beginPath(),e.arc(i-r,a,l,0,Math.PI*2),e.arc(i+r,a,l,0,Math.PI*2),e.fill(),e.fillStyle="#ffffff",e.beginPath(),e.arc(i-r-l*.3,a-l*.3,l*.3,0,Math.PI*2),e.arc(i+r-l*.3,a-l*.3,l*.3,0,Math.PI*2),e.fill())}drawChefCharacter(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.arc(i-t*.1,a-t*.28,t*.1,0,Math.PI*2),e.arc(i+t*.1,a-t*.28,t*.1,0,Math.PI*2),e.arc(i,a-t*.35,t*.12,0,Math.PI*2),e.fill(),e.fillRect(i-t*.15,a-t*.22,t*.3,t*.12),this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"happy"),e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.arc(i-t*.03,a+t*.08,t*.04,0,Math.PI),e.stroke(),e.beginPath(),e.arc(i+t*.03,a+t*.08,t*.04,0,Math.PI),e.stroke()}drawCoolCharacter(e,i,a,t,s){e.fillStyle=s;const n=a-t*.02,r=t*.12;this.drawStar(e,i-t*.18,n,r,4),this.drawStar(e,i+t*.18,n,r,4),e.fillRect(i-t*.08,n-t*.01,t*.16,t*.02),this.drawBlush(e,i,a,t),e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.arc(i-t*.03,a+t*.1,t*.04,0,Math.PI),e.stroke(),e.beginPath(),e.arc(i+t*.03,a+t*.1,t*.04,0,Math.PI),e.stroke()}drawPirateCharacter(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.ellipse(i,a-t*.2,t*.25,t*.1,0,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(i+t*.2,a-t*.22,t*.06,0,Math.PI*2),e.fill(),e.fillStyle=s,this.drawStar(e,i-t*.15,a,t*.08,4),e.strokeStyle=s,e.lineWidth=t*.02,e.beginPath(),e.moveTo(i-t*.22,a-t*.05),e.lineTo(i-t*.1,a-t*.25),e.stroke(),this.drawBlush(e,i,a,t),e.fillStyle=s,e.beginPath(),e.arc(i+t*.12,a,t*.07,0,Math.PI*2),e.fill(),e.fillStyle="#ffffff",e.beginPath(),e.arc(i+t*.1,a-t*.02,t*.02,0,Math.PI*2),e.fill(),e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.arc(i,a+t*.08,t*.08,0,Math.PI),e.stroke()}drawAlienCharacter(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.moveTo(i-t*.1,a-t*.1),e.lineTo(i-t*.18,a-t*.3),e.stroke(),e.beginPath(),e.moveTo(i+t*.1,a-t*.1),e.lineTo(i+t*.18,a-t*.3),e.stroke(),e.fillStyle=s,this.drawStar(e,i-t*.18,a-t*.3,t*.05,4),this.drawStar(e,i+t*.18,a-t*.3,t*.05,4),this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"normal"),e.beginPath(),e.arc(i,a+t*.12,t*.04,0,Math.PI*2),e.fill()}drawRobotCharacter(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.moveTo(i,a-t*.1),e.lineTo(i,a-t*.3),e.stroke(),e.fillStyle=s,this.drawStar(e,i,a-t*.3,t*.06,4),this.drawBlush(e,i,a,t);const n=t*.18,r=t*.12;e.fillRect(i-n-r/2,a-r/2,r,r),e.fillRect(i+n-r/2,a-r/2,r,r),e.fillStyle="#ffffff",e.fillRect(i-n-r*.3,a-r*.3,r*.3,r*.3),e.fillRect(i+n-r*.3,a-r*.3,r*.3,r*.3),e.fillStyle=s;for(let l=0;l<3;l++)e.fillRect(i-t*.06+l*t*.06,a+t*.12,t*.03,t*.03)}drawWizardCharacter(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.moveTo(i,a-t*.4),e.quadraticCurveTo(i+t*.1,a-t*.3,i+t*.2,a-t*.1),e.lineTo(i-t*.2,a-t*.1),e.quadraticCurveTo(i-t*.1,a-t*.3,i,a-t*.4),e.fill(),this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"sparkle"),e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.arc(i-t*.03,a+t*.08,t*.04,0,Math.PI),e.stroke(),e.beginPath(),e.arc(i+t*.03,a+t*.08,t*.04,0,Math.PI),e.stroke(),e.fillStyle=s,e.beginPath(),e.arc(i,a+t*.15,t*.06,0,Math.PI*2),e.fill()}drawKingCharacter(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.moveTo(i-t*.2,a-t*.1),e.lineTo(i-t*.2,a-t*.25),e.lineTo(i-t*.08,a-t*.15),e.lineTo(i,a-t*.3),e.lineTo(i+t*.08,a-t*.15),e.lineTo(i+t*.2,a-t*.25),e.lineTo(i+t*.2,a-t*.1),e.closePath(),e.fill(),this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"normal"),e.strokeStyle=s,e.lineWidth=t*.03,e.beginPath(),e.arc(i,a+t*.06,t*.1,0,Math.PI),e.stroke()}drawNinjaCharacter(e,i,a,t,s){e.fillStyle=s,e.fillRect(i-t*.25,a-t*.12,t*.5,t*.15),e.beginPath(),e.arc(i+t*.22,a-t*.1,t*.05,0,Math.PI*2),e.fill(),this.drawKawaiiEyes(e,i,a,t,s,"normal"),this.drawBlush(e,i,a,t)}drawAstronautCharacter(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.05,e.beginPath(),e.arc(i,a,t*.25,0,Math.PI*2),e.stroke(),this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"normal"),e.beginPath(),e.moveTo(i+t*.2,a-t*.15),e.lineTo(i+t*.3,a-t*.35),e.stroke(),e.fillStyle=s,this.drawStar(e,i+t*.3,a-t*.35,t*.06,4),e.fillStyle="#ffffff",this.drawStar(e,i-t*.15,a-t*.15,t*.03,4)}drawLegendCharacter(e,i,a,t,s){this.drawBlush(e,i,a,t),this.drawKawaiiEyes(e,i,a,t,s,"sparkle"),e.strokeStyle=s,e.lineWidth=t*.04,e.beginPath(),e.arc(i-t*.04,a+t*.08,t*.05,0,Math.PI),e.stroke(),e.beginPath(),e.arc(i+t*.04,a+t*.08,t*.05,0,Math.PI),e.stroke();for(let n=0;n<5;n++){const r=n*Math.PI*2/5,l=i+Math.cos(r)*t*.3,o=a+Math.sin(r)*t*.3;this.drawStar(e,l,o,t*.04,4)}}drawStar(e,i,a,t,s){e.beginPath();for(let n=0;n<s*2;n++){const r=n%2===0?t:t*.4,l=n*Math.PI/s-Math.PI/2,o=i+Math.cos(l)*r,d=a+Math.sin(l)*r;n===0?e.moveTo(o,d):e.lineTo(o,d)}e.closePath(),e.fill()}markDiscovered(e){if(!(e<6))try{const i=JSON.parse(localStorage.getItem("threes_discovered")||"[]");i.includes(e)||(i.push(e),localStorage.setItem("threes_discovered",JSON.stringify(i)),console.log("[ThreesGame.markDiscovered] New discovery:",e))}catch{}}static getDiscovered(){try{return JSON.parse(localStorage.getItem("threes_discovered")||"[]")}catch{return[]}}static GALLERY_CHARACTERS=[{value:6,name:"Happy"},{value:12,name:"Joy"},{value:24,name:"Chef"},{value:48,name:"Cool"},{value:96,name:"Pirate"},{value:192,name:"Alien"},{value:384,name:"Robot"},{value:768,name:"Wizard"},{value:1536,name:"King"},{value:3072,name:"Ninja"},{value:6144,name:"Astronaut"},{value:12288,name:"Legend"}];galleryReturnTo="start";showGallery(){console.log("[ThreesGame.showGallery] Opening gallery from start"),this.galleryReturnTo="start";const e=document.getElementById("galleryScreen"),i=document.getElementById("startScreen");!e||!i||(i.classList.add("hidden"),e.classList.remove("hidden"),this.renderGallery())}showGalleryFromGameOver(){console.log("[ThreesGame.showGalleryFromGameOver] Opening gallery from game over"),this.galleryReturnTo="gameover";const e=document.getElementById("galleryScreen"),i=document.getElementById("gameOverScreen"),a=document.getElementById("hud");!e||!i||(i.classList.add("hidden"),a&&(a.style.display="none"),this.canvas.style.visibility="hidden",e.classList.remove("hidden"),this.renderGallery())}hideGallery(){console.log("[ThreesGame.hideGallery] Closing gallery, returning to:",this.galleryReturnTo);const e=document.getElementById("galleryScreen"),i=document.getElementById("startScreen"),a=document.getElementById("gameOverScreen"),t=document.getElementById("hud");e&&(e.classList.add("hidden"),this.galleryReturnTo==="gameover"&&a?(this.canvas.style.visibility="visible",t&&(t.style.display="flex"),a.classList.remove("hidden")):i&&i.classList.remove("hidden"))}renderGallery(){const e=document.getElementById("galleryGrid"),i=document.getElementById("discoveryCount"),a=document.getElementById("discoveryTotal");if(!e)return;const t=w.getDiscovered(),s=w.GALLERY_CHARACTERS;e.innerHTML="";let n=0;s.forEach(r=>{const l=t.includes(r.value);l&&n++;const o=document.createElement("div");if(o.className="gallery-item "+(l?"discovered":"locked"),l){const d=document.createElement("canvas"),u=80;d.width=u,d.height=u,d.style.width="100%",d.style.height="100%";const f=d.getContext("2d");f&&this.renderGalleryTile(f,r.value,u/2,u/2,u-4),o.appendChild(d);const m=document.createElement("div");m.className="gallery-character-name",m.textContent=r.name,o.appendChild(m)}e.appendChild(o)}),i&&(i.textContent=n.toString()),a&&(a.textContent=s.length.toString())}renderGalleryTile(e,i,a,t,s){const n=p(i),r=12;e.fillStyle=n.bg,this.roundRect(e,a-s/2,t-s/2,s,s,r),e.fill();const l=s*.08;e.fillStyle=n.border,e.beginPath(),e.moveTo(a-s/2+r,t+s/2),e.lineTo(a+s/2-r,t+s/2),e.quadraticCurveTo(a+s/2,t+s/2,a+s/2,t+s/2-r),e.lineTo(a+s/2,t+s/2-l),e.lineTo(a-s/2,t+s/2-l),e.lineTo(a-s/2,t+s/2-r),e.quadraticCurveTo(a-s/2,t+s/2,a-s/2+r,t+s/2),e.closePath(),e.fill();const o=t-s*.08;i===6?this.draw6Face(e,a,t,s,n.text):i===12?this.draw12Face(e,a,t,s,n.text):i===24?this.drawChefCharacter(e,a,o,s,n.text):i===48?this.drawCoolCharacter(e,a,o,s,n.text):i===96?this.drawPirateCharacter(e,a,o,s,n.text):i===192?this.drawAlienCharacter(e,a,o,s,n.text):i===384?this.drawRobotCharacter(e,a,o,s,n.text):i===768?this.drawWizardCharacter(e,a,o,s,n.text):i===1536?this.drawKingCharacter(e,a,o,s,n.text):i===3072?this.drawNinjaCharacter(e,a,o,s,n.text):i===6144?this.drawAstronautCharacter(e,a,o,s,n.text):this.drawLegendCharacter(e,a,o,s,n.text);const d=i>=1e3?s*.22:i>=100?.26:s*.3;e.font="700 "+d+"px Quicksand, sans-serif",e.textAlign="center",e.textBaseline="bottom",e.fillStyle=n.text,e.fillText(i.toString(),a,t+s/2-s*.06)}drawClosedEyes(e,i,a,t,s,n){e.strokeStyle=n,e.lineWidth=s*.4,e.lineCap="round",e.beginPath(),e.arc(i-t,a,s,.2*Math.PI,.8*Math.PI),e.stroke(),e.beginPath(),e.arc(i+t,a,s,.2*Math.PI,.8*Math.PI),e.stroke()}drawOpenEyes(e,i,a,t,s,n,r){if(e.fillStyle=n,e.beginPath(),e.arc(i-t,a,s,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(i+t,a,s,0,Math.PI*2),e.fill(),r){e.fillStyle="#ffffff";const l=s*.4;e.beginPath(),e.arc(i-t-s*.3,a-s*.3,l,0,Math.PI*2),e.fill(),e.beginPath(),e.arc(i+t-s*.3,a-s*.3,l,0,Math.PI*2),e.fill()}}drawHappyEyes(e,i,a,t,s,n){e.strokeStyle=n,e.lineWidth=s*.5,e.lineCap="round",e.beginPath(),e.arc(i-t,a+s*.5,s,1.2*Math.PI,1.8*Math.PI),e.stroke(),e.beginPath(),e.arc(i+t,a+s*.5,s,1.2*Math.PI,1.8*Math.PI),e.stroke()}drawDeterminedEyes(e,i,a,t,s,n){e.fillStyle=n,e.save(),e.beginPath(),e.ellipse(i-t,a,s,s*.7,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(i+t,a,s,s*.7,0,0,Math.PI*2),e.fill(),e.restore()}drawHalfClosedEyes(e,i,a,t,s,n){e.fillStyle=n,e.save(),e.beginPath(),e.ellipse(i-t,a,s,s*.5,0,0,Math.PI*2),e.fill(),e.beginPath(),e.ellipse(i+t,a,s,s*.5,0,0,Math.PI*2),e.fill(),e.restore()}drawSparkleEyes(e,i,a,t,s,n){e.fillStyle=n;const r=4,l=s*.4,o=s;for(const d of[-t,t]){e.beginPath();for(let u=0;u<r*2;u++){const f=u%2===0?o:l,m=u*Math.PI/r-Math.PI/2,c=i+d+Math.cos(m)*f,S=a+Math.sin(m)*f;u===0?e.moveTo(c,S):e.lineTo(c,S)}e.closePath(),e.fill()}}drawStarEyes(e,i,a,t,s,n){e.fillStyle=n;const r=5,l=s*.45,o=s;for(const d of[-t,t]){e.beginPath();for(let u=0;u<r*2;u++){const f=u%2===0?o:l,m=u*Math.PI/r-Math.PI/2,c=i+d+Math.cos(m)*f,S=a+Math.sin(m)*f;u===0?e.moveTo(c,S):e.lineTo(c,S)}e.closePath(),e.fill()}}drawSmallSmile(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.25,e.lineCap="round",e.beginPath(),e.arc(i,a-t*.3,t,.15*Math.PI,.85*Math.PI),e.stroke()}drawSmile(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.22,e.lineCap="round",e.beginPath(),e.arc(i,a-t*.5,t,.15*Math.PI,.85*Math.PI),e.stroke()}drawBigSmile(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.arc(i,a-t*.3,t,.1*Math.PI,.9*Math.PI),e.closePath(),e.fill()}drawSmirk(e,i,a,t,s){e.strokeStyle=s,e.lineWidth=t*.25,e.lineCap="round",e.beginPath(),e.moveTo(i-t*.8,a),e.quadraticCurveTo(i,a+t*.4,i+t*.9,a-t*.2),e.stroke()}drawGrin(e,i,a,t,s){e.fillStyle=s,e.beginPath(),e.arc(i,a-t*.2,t,.05*Math.PI,.95*Math.PI),e.closePath(),e.fill(),e.strokeStyle="#ffffff",e.lineWidth=t*.1,e.beginPath(),e.moveTo(i-t*.5,a+t*.2),e.lineTo(i+t*.5,a+t*.2),e.stroke()}roundRect(e,i,a,t,s,n){e.beginPath(),e.moveTo(i+n,a),e.lineTo(i+t-n,a),e.quadraticCurveTo(i+t,a,i+t,a+n),e.lineTo(i+t,a+s-n),e.quadraticCurveTo(i+t,a+s,i+t-n,a+s),e.lineTo(i+n,a+s),e.quadraticCurveTo(i,a+s,i,a+s-n),e.lineTo(i,a+n),e.quadraticCurveTo(i,a,i+n,a),e.closePath()}}window.addEventListener("DOMContentLoaded",()=>{console.log("[main] Initializing Threes!"),new w});</script>
</head>
<body>
    <canvas id="gameCanvas"></canvas>

    <!-- Audio Controls -->
    <div class="audio-controls">
        <button class="audio-btn" id="musicToggle" title="Toggle Music">
            <svg id="musicOnIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
            </svg>
            <svg id="musicOffIcon" style="display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 18V5l12-2v13"></path>
                <circle cx="6" cy="18" r="3"></circle>
                <circle cx="18" cy="16" r="3"></circle>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        </button>
        <button class="audio-btn" id="sfxToggle" title="Toggle Sound Effects">
            <svg id="sfxOnIcon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
            </svg>
            <svg id="sfxOffIcon" style="display: none;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                <line x1="23" y1="9" x2="17" y2="15"></line>
                <line x1="17" y1="9" x2="23" y2="15"></line>
            </svg>
        </button>
    </div>
    
    <!-- HUD -->
    <div id="hud" style="display: none;">
        <div class="hud-section">
            <div class="score-container">
                <div class="score-label">score</div>
                <div class="score-value" id="score">0</div>
            </div>
        </div>
        <div class="hud-center">
            <div class="next-label">next</div>
            <div class="next-tile-preview" id="nextTilePreview"></div>
        </div>
        <div class="hud-section" style="align-items: flex-end;">
            <div class="score-container best">
                <div class="score-label">best</div>
                <div class="score-value" id="highScore">0</div>
            </div>
        </div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="overlay">
        <div class="content">
            <div class="game-logo">
                <div class="logo-tiles">
                    <div class="logo-tile blue">1</div>
                    <div class="logo-tile purple">2</div>
                    <div class="logo-tile white">3</div>
                </div>
            </div>
            <h1>threes!</h1>
            <p class="subtitle">a tiny puzzle that grows on you</p>
            <button class="btn" id="startButton">play</button>
            <button class="btn btn-gallery" id="galleryButton">gallery</button>
            <div class="how-to-play">
                <h3>how to play</h3>
                <div class="instructions">
                    <div class="instruction">
                        <span class="instruction-icon icon-swipe">
                            <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                                <path d="M12 4l-6 6h4v8h4v-8h4l-6-6z"/>
                            </svg>
                        </span>
                        <span>swipe to slide tiles</span>
                    </div>
                    <div class="instruction">
                        <span class="instruction-icon icon-merge">+</span>
                        <span>1+2=3, then match pairs</span>
                    </div>
                    <div class="instruction">
                        <span class="instruction-icon icon-score">
                            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                                <path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/>
                            </svg>
                        </span>
                        <span>build the highest tiles!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="overlay hidden">
        <div class="content">
            <h2 class="game-over-title">no more moves</h2>
            <p class="game-over-subtitle">but look how far you got!</p>
            <div class="final-score-container">
                <div class="final-score-label">final score</div>
                <div class="final-score" id="finalScore">0</div>
                <div class="highest-tile" id="highestTile">highest: 48</div>
            </div>
            <div class="stats-row">
                <div class="stat-item">
                    <div class="stat-value" id="movesMade">0</div>
                    <div class="stat-label">moves</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="mergesMade">0</div>
                    <div class="stat-label">merges</div>
                </div>
            </div>
            <div class="game-over-buttons">
                <button class="btn btn-secondary" id="restartButton">try again</button>
                <button class="btn btn-gallery" id="gameOverGalleryButton">gallery</button>
            </div>
        </div>
    </div>

    <!-- Gallery Screen -->
    <div id="galleryScreen" class="overlay hidden">
        <div class="gallery-content">
            <h2 class="gallery-title">character gallery</h2>
            <p class="gallery-subtitle">discover all the personalities!</p>
            <div class="gallery-grid" id="galleryGrid">
                <!-- Tiles populated by JS -->
            </div>
            <div class="discovery-progress">
                <span id="discoveryCount">0</span> / <span id="discoveryTotal">10</span> discovered
            </div>
            <button class="btn" id="galleryBackButton">back</button>
        </div>
    </div>

</body>
</html>
